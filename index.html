<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Fiscal TCP Pro - Cuba</title>
    
    <!-- Para PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestor TCP">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            transition: background-color 0.3s;
        }
        
        body.dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .dark .section-card {
            background: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .btn-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #64748b;
            background: white;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        
        .dark .btn-tab {
            background: #1e293b;
            color: #94a3b8;
        }

        .btn-tab.active {
            background-color: #2563eb;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 10px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .dark .input-field {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            ring: 2px rgba(37, 99, 235, 0.1);
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            border-radius: 99px;
            background-color: #cbd5e1;
            position: relative;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        
        .dark .toggle-switch {
            background-color: #475569;
        }

        .toggle-dot {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        input:checked + .toggle-switch {
            background-color: #22c55e;
        }

        input:checked + .toggle-switch .toggle-dot {
            transform: translateX(24px);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .dark .table-container {
            border-color: #334155;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f8fafc;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .dark th {
            background-color: #0f172a;
            color: #94a3b8;
            border-bottom-color: #334155;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }
        
        .dark td {
            border-bottom-color: #334155;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #22c55e20;
            color: #22c55e;
            border: 1px solid #22c55e40;
        }
        
        .badge-warning {
            background-color: #f59e0b20;
            color: #f59e0b;
            border: 1px solid #f59e0b40;
        }
        
        .badge-info {
            background-color: #3b82f620;
            color: #3b82f6;
            border: 1px solid #3b82f640;
        }
        
        /* Indicador de estado */
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .online { background-color: #22c55e; color: white; }
        .offline { background-color: #ef4444; color: white; }
        
        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        
        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: #1e293b;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        [data-tooltip]:hover:before {
            opacity: 1;
        }
        
        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .btn-tab span { font-size: 10px; }
            .section-card { padding: 16px; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Indicador de conexi칩n -->
    <div id="connection-status" class="online">游릭 Conectado</div>
    
    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Header con logo personalizado -->
        <header class="flex flex-wrap justify-between items-center mb-8 gap-2">
            <h1 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                <!-- Logo SVG incluido directamente -->
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8">
                    <rect width="32" height="32" rx="8" fill="#2563EB"/>
                    <path d="M8 16L14 22L24 10" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="24" cy="8" r="2" fill="white"/>
                    <circle cx="8" cy="24" r="2" fill="white"/>
                </svg>
                Gestor Fiscal TCP Pro
            </h1>
            <div class="flex gap-2">
                <!-- Indicador de guardado -->
                <div id="save-indicator" class="flex items-center gap-1 px-3 py-1 bg-white dark:bg-slate-800 rounded-full border text-xs shadow-sm" title="Estado de guardado">
                    <i data-lucide="check-circle" class="w-3 h-3 text-green-600"></i>
                    <span>Guardado</span>
                </div>
                
                <!-- Toggle tema oscuro -->
                <button onclick="toggleDarkMode()" class="p-2 bg-white dark:bg-slate-800 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" title="Cambiar tema">
                    <i data-lucide="moon" class="w-5 h-5 text-slate-400"></i>
                </button>
                
                <!-- Exportar datos -->
                <button onclick="exportData()" class="p-2 bg-white dark:bg-slate-800 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" title="Exportar respaldo">
                    <i data-lucide="download" class="w-5 h-5 text-slate-400"></i>
                </button>
                
                <!-- Importar datos -->
                <label class="p-2 bg-white dark:bg-slate-800 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer transition-colors" title="Importar respaldo">
                    <i data-lucide="upload" class="w-5 h-5 text-slate-400"></i>
                    <input type="file" class="hidden" onchange="importData(event)" accept=".json">
                </label>
                
                <!-- Respaldo manual -->
                <button onclick="createBackup()" class="p-2 bg-blue-600 text-white border rounded-lg hover:bg-blue-700 transition-colors" title="Crear respaldo manual">
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Navegaci칩n por Iconos (5 pesta침as) -->
        <nav class="grid grid-cols-5 gap-2 md:gap-4 mb-8">
            <button onclick="switchTab('calc')" id="tab-calc" class="btn-tab active">
                <i data-lucide="calculator" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Calculadora</span>
            </button>
            <button onclick="switchTab('records')" id="tab-records" class="btn-tab">
                <i data-lucide="users" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Clientes</span>
            </button>
            <button onclick="switchTab('taxes')" id="tab-taxes" class="btn-tab">
                <i data-lucide="receipt" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Impuestos</span>
            </button>
            <button onclick="switchTab('dj')" id="tab-dj" class="btn-tab">
                <i data-lucide="file-text" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">DJ Anual</span>
            </button>
            <button onclick="switchTab('reports')" id="tab-reports" class="btn-tab">
                <i data-lucide="bar-chart-2" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Reportes</span>
            </button>
        </nav>

        <!-- SECCI칍N 1: CALCULADORA -->
        <section id="section-calc">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Configuraci칩n de Actividad
                </h2>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-4">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300">쯊iene empleados contratados?</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="has-employees" class="sr-only" onchange="toggleEmployees()">
                        <div class="toggle-switch">
                            <div class="toggle-dot"></div>
                        </div>
                    </label>
                </div>

                <div id="employee-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 animate-in fade-in duration-300">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="N칰mero total de empleados">Cant. Empleados</label>
                        <input type="number" id="emp-count" oninput="calculateTaxes()" class="input-field" value="1" min="1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Total de salarios pagados en el mes">Total Salarios (CUP)</label>
                        <input type="number" id="emp-salaries" oninput="calculateTaxes()" class="input-field" placeholder="0.00" min="0" step="100" value="0">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Ingresos brutos del mes">Ingresos Brutos (Mes)</label>
                        <input type="number" id="monthly-income" oninput="calculateTaxes()" class="input-field" placeholder="0.00" min="0" step="100" value="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Aportaci칩n a la Seguridad Social">Seguridad Social (CESS)</label>
                        <select id="cess-scale" onchange="calculateTaxes()" class="input-field">
                            <option value="300">Escala 2000 (Cuota 300)</option>
                            <option value="450">Escala 3000 (Cuota 450)</option>
                            <option value="750">Escala 5000 (Cuota 750)</option>
                            <option value="1500">Escala 10000 (Cuota 1500)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Cliente al que facturamos">Cliente</label>
                        <select id="tax-client" class="input-field">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-end">
                    <button onclick="registerTaxPayment()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Registrar Pago de Impuestos
                    </button>
                </div>
            </div>

            <!-- Resumen de Impuestos a Pagar -->
            <div class="section-card border-l-4 border-blue-600">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    Resumen de Impuestos a Pagar
                </h2>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Ventas/Servicios (10%):</span>
                        <span id="res-sales" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Ingresos Personales (5%):</span>
                        <span id="res-personal" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div id="row-work" class="hidden flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Util. Fuerza Trabajo (5%):</span>
                        <span id="res-work" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div id="row-ss" class="hidden flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Seguridad Social Empl. (14%):</span>
                        <span id="res-ss-empl" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Contribuci칩n CESS:</span>
                        <span id="res-cess" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div class="pt-3 border-t dark:border-slate-700 flex justify-between items-center">
                        <span class="font-bold text-slate-800 dark:text-white">TOTAL A PAGAR:</span>
                        <span id="res-total" class="text-xl font-black text-blue-600">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCI칍N 2: CLIENTES -->
        <section id="section-records" class="hidden">
            <div class="section-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-slate-700 dark:text-white flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        Historial por Cliente
                    </h2>
                    <button onclick="promptNewClient()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700 transition-colors flex items-center gap-1">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Nuevo Cliente
                    </button>
                </div>

                <div class="flex gap-2 overflow-x-auto pb-4 mb-4 flex-wrap" id="client-tags">
                    <!-- Clientes se renderizan aqu칤 -->
                </div>

                <div id="client-content" class="hidden">
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl mb-6">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Nuevo Movimiento</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            <select id="move-type" class="input-field text-xs">
                                <option value="income">Ingreso (+)</option>
                                <option value="expense">Gasto (-)</option>
                            </select>
                            <input type="text" id="move-concept" class="input-field text-xs" placeholder="Concepto">
                            <input type="number" id="move-amount" class="input-field text-xs" placeholder="Monto $" min="0" step="100">
                            <input type="date" id="move-date" class="input-field text-xs" value="">
                            <button onclick="addMovement()" class="bg-blue-600 text-white text-xs font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                                Registrar
                            </button>
                        </div>
                    </div>

                    <!-- Resumen del cliente seleccionado -->
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded text-center">
                            <span class="text-[10px] text-green-600 dark:text-green-400 uppercase">Ingresos</span>
                            <p id="client-income-total" class="text-sm font-bold text-green-600">0.00</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 p-2 rounded text-center">
                            <span class="text-[10px] text-red-600 dark:text-red-400 uppercase">Gastos</span>
                            <p id="client-expense-total" class="text-sm font-bold text-red-600">0.00</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-center">
                            <span class="text-[10px] text-blue-600 dark:text-blue-400 uppercase">Balance</span>
                            <p id="client-balance" class="text-sm font-bold text-blue-600">0.00</p>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Tipo</th>
                                    <th class="text-right">Monto</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table-body">
                                <!-- Movimientos se renderizan aqu칤 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="no-client-hint" class="text-center py-10 text-slate-400 text-sm">
                    <i data-lucide="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    Selecciona o crea un cliente para ver sus registros.
                </div>
            </div>
        </section>

        <!-- SECCI칍N 3: IMPUESTOS -->
        <section id="section-taxes" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    Historial de Impuestos Pagados
                </h2>
                
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cliente</label>
                        <select id="tax-filter-client" class="input-field text-sm" onchange="filterTaxes()">
                            <option value="all">Todos los clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Mes</label>
                        <select id="tax-filter-month" class="input-field text-sm" onchange="filterTaxes()">
                            <option value="all">Todos los meses</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">A침o</label>
                        <select id="tax-filter-year" class="input-field text-sm" onchange="filterTaxes()">
                            <option value="all">Todos los a침os</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="exportTaxesCSV()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition-colors flex items-center gap-1">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar CSV
                        </button>
                    </div>
                </div>
                
                <!-- Resumen de impuestos -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Total Impuestos</span>
                        <p id="tax-total-amount" class="text-xl font-bold text-blue-600">0.00</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Ventas (10%)</span>
                        <p id="tax-total-sales" class="text-lg font-bold text-purple-600">0.00</p>
                    </div>
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Ingresos Personales</span>
                        <p id="tax-total-personal" class="text-lg font-bold text-indigo-600">0.00</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">CESS</span>
                        <p id="tax-total-cess" class="text-lg font-bold text-orange-600">0.00</p>
                    </div>
                </div>
                
                <!-- Tabla de impuestos -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Concepto</th>
                                <th class="text-right">Ventas</th>
                                <th class="text-right">Personal</th>
                                <th class="text-right">F. Trabajo</th>
                                <th class="text-right">SS Empl.</th>
                                <th class="text-right">CESS</th>
                                <th class="text-right">Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tax-table-body">
                            <!-- Impuestos se renderizan aqu칤 -->
                        </tbody>
                        <tfoot id="tax-table-footer" class="bg-slate-50 dark:bg-slate-800 font-bold">
                            <!-- Totales se renderizan aqu칤 -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECCI칍N 4: DJ ANUAL -->
        <section id="section-dj" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-6 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    Declaraci칩n Jurada Anual
                </h2>
                
                <!-- Selector de cliente y a침o -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cliente</label>
                        <select id="dj-client" class="input-field" onchange="calculateDJ()">
                            <option value="all">Todos los clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">A침o</label>
                        <select id="dj-year" class="input-field" onchange="calculateDJ()">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="generatePDF()" class="bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-700 transition-colors flex items-center gap-1">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Generar PDF
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-100 dark:border-green-800 text-center">
                        <p class="text-[10px] font-bold text-green-600 dark:text-green-400 uppercase">Ingresos Totales</p>
                        <p id="dj-incomes" class="text-lg font-bold text-green-600">0.00</p>
                    </div>
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-800 text-center">
                        <p class="text-[10px] font-bold text-red-600 dark:text-red-400 uppercase">Gastos Totales</p>
                        <p id="dj-expenses" class="text-lg font-bold text-red-600">0.00</p>
                    </div>
                </div>
                
                <div class="p-4 bg-slate-900 text-white rounded-xl mb-6 text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Rendimiento Neto</p>
                    <p id="dj-net" class="text-2xl font-black">0.00</p>
                </div>
                
                <!-- Tabla de c치lculo progresivo -->
                <div class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <div class="flex justify-between">
                        <span>M칤nimo Exento:</span>
                        <span>39,120.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Base Imponible:</span>
                        <span id="dj-base">0.00</span>
                    </div>
                    <div class="flex justify-between font-bold text-slate-800 dark:text-white pt-2 border-t dark:border-slate-700">
                        <span>Impuesto DJ a Pagar:</span>
                        <span id="dj-tax" class="text-blue-600">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCI칍N 5: REPORTES -->
        <section id="section-reports" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    Reportes y Estad칤sticas
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <p class="text-xs text-slate-500 dark:text-slate-400">Total Clientes</p>
                        <p id="report-total-clients" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                        <p class="text-xs text-slate-500 dark:text-slate-400">Total Movimientos</p>
                        <p id="report-total-movements" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded">
                        <p class="text-xs text-slate-500 dark:text-slate-400">Ingresos Totales</p>
                        <p id="report-total-income" class="text-xl font-bold text-green-600">0.00</p>
                    </div>
                    <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded">
                        <p class="text-xs text-slate-500 dark:text-slate-400">Gastos Totales</p>
                        <p id="report-total-expense" class="text-xl font-bold text-red-600">0.00</p>
                    </div>
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded">
                        <p class="text-xs text-slate-500 dark:text-slate-400">Balance Neto</p>
                        <p id="report-net" class="text-xl font-bold text-blue-600">0.00</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border">
                        <canvas id="incomeExpenseChart" style="height: 250px;"></canvas>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border">
                        <canvas id="taxBreakdownChart" style="height: 250px;"></canvas>
                    </div>
                </div>
                
                <!-- Desglose por cliente -->
                <h3 class="text-md font-bold mb-3">Resumen por Cliente</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th class="text-right">Ingresos</th>
                                <th class="text-right">Gastos</th>
                                <th class="text-right">Balance</th>
                                <th class="text-right">Impuestos</th>
                            </tr>
                        </thead>
                        <tbody id="report-client-breakdown">
                            <!-- Datos por cliente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <footer class="text-center text-[10px] text-slate-400 mt-10">
            춸 2026 Gestor Fiscal TCP Pro. Versi칩n 3.0 - Con respaldo autom치tico
        </footer>
    </div>

    <!-- Bot칩n de respaldo y restauraci칩n -->
    <div class="fixed bottom-4 right-4 flex gap-2">
        <button onclick="restoreFromBackup()" class="bg-purple-600 text-white px-3 py-2 rounded-full shadow-lg text-xs flex items-center gap-1 hover:bg-purple-700 transition-colors" title="Restaurar respaldo">
            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
            Restaurar
        </button>
        <button onclick="showBackupList()" class="bg-blue-600 text-white px-3 py-2 rounded-full shadow-lg text-xs flex items-center gap-1 hover:bg-blue-700 transition-colors" title="Ver respaldos">
            <i data-lucide="archive" class="w-3 h-3"></i>
            Respaldos
        </button>
    </div>

    <script>
        // --- CONSTANTES ---
        const TAX_RATES = {
            ventas: 0.10,
            ingresos_personales: 0.05,
            fuerza_trabajo: 0.05,
            seguridad_social_empleador: 0.14
        };
        
        // Tabla de impuestos progresivos (Cuba)
        const TAX_BRACKETS = [
            { min: 0, max: 39120, rate: 0, base: 0 },
            { min: 39120, max: 58680, rate: 0.15, base: 0 },
            { min: 58680, max: 90000, rate: 0.20, base: 2934 },
            { min: 90000, max: 120000, rate: 0.25, base: 9198 },
            { min: 120000, max: Infinity, rate: 0.30, base: 16698 }
        ];

        // --- ESTADO INICIAL CON DATOS DE EJEMPLO ---
        let state = {
            clients: [
                {
                    id: 1,
                    name: "Cliente Ejemplo",
                    movements: [
                        { id: 101, date: "2026-01-15", type: "income", concept: "Venta servicios", amount: 50000 },
                        { id: 102, date: "2026-01-20", type: "expense", concept: "Compra materiales", amount: 15000 }
                    ]
                }
            ],
            taxPayments: [
                { id: 1001, clientId: 1, clientName: "Cliente Ejemplo", date: "2026-01-31", month: 1, year: 2026, income: 50000, salesTax: 5000, personalTax: 2500, workTax: 0, ssTax: 0, cess: 300, total: 7800 }
            ],
            selectedClientId: 1,
            config: {
                hasEmployees: true,
                darkMode: false
            }
        };

        let incomeExpenseChart = null;
        let taxBreakdownChart = null;

        // --- FUNCI칍N DE GUARDADO MEJORADA ---
        function save(showNotification = false) {
            try {
                // Guardar en localStorage
                localStorage.setItem('tcp_data_v5', JSON.stringify(state));
                
                // Guardar respaldo diario
                const today = new Date().toISOString().split('T')[0];
                localStorage.setItem(`tcp_backup_${today}`, JSON.stringify(state));
                
                // Limpiar respaldos viejos (mantener solo 칰ltimos 7 d칤as)
                const keys = [];
                for(let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if(key && key.startsWith('tcp_backup_')) {
                        keys.push(key);
                    }
                }
                
                // Ordenar y eliminar los m치s viejos si hay m치s de 7
                keys.sort().reverse();
                for(let i = 7; i < keys.length; i++) {
                    localStorage.removeItem(keys[i]);
                }
                
                // Actualizar indicador
                const indicator = document.getElementById('save-indicator');
                if(indicator) {
                    const icon = indicator.querySelector('i');
                    const text = indicator.querySelector('span');
                    icon.setAttribute('data-lucide', 'check-circle');
                    text.textContent = 'Guardado';
                    lucide.createIcons();
                }
                
                if(showNotification) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Guardado',
                        text: 'Datos guardados correctamente',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
                
                return true;
            } catch(e) {
                console.error('Error guardando:', e);
                
                // Mostrar error
                Swal.fire({
                    icon: 'error',
                    title: 'Error al guardar',
                    text: 'No se pudo guardar los datos. Intenta exportar manualmente.',
                    confirmButtonText: 'OK'
                });
                
                return false;
            }
        }

        // --- CARGA DE DATOS ---
        function loadState() {
            try {
                // Intentar cargar de m칰ltiples fuentes
                const sources = [
                    localStorage.getItem('tcp_data_v5'),
                    localStorage.getItem('tcp_data_v4'),
                    localStorage.getItem(`tcp_backup_${new Date().toISOString().split('T')[0]}`)
                ];
                
                for(let source of sources) {
                    if(source) {
                        try {
                            const loaded = JSON.parse(source);
                            if(loaded && loaded.clients) {
                                state = loaded;
                                break;
                            }
                        } catch(e) {}
                    }
                }
                
                // Asegurar estructura
                if(!state.clients) state.clients = [];
                if(!state.taxPayments) state.taxPayments = [];
                if(!state.config) state.config = { hasEmployees: false, darkMode: false };
                
                // Si no hay clientes, agregar ejemplo
                if(state.clients.length === 0) {
                    state.clients.push({
                        id: 1,
                        name: "Cliente Ejemplo",
                        movements: []
                    });
                }
                
                // Seleccionar primer cliente si no hay selecci칩n
                if(state.clients.length > 0 && !state.selectedClientId) {
                    state.selectedClientId = state.clients[0].id;
                }
                
            } catch(e) {
                console.error('Error cargando:', e);
            }
            
            return state;
        }

        // --- INICIO ---
        window.onload = () => {
            lucide.createIcons();
            loadState();
            renderClients();
            updateClientSelects();
            calculateTaxes();
            calculateReports();
            
            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('move-date');
            if(dateInput) dateInput.value = today;
            
            // Restaurar tema oscuro
            if(state.config && state.config.darkMode) {
                document.body.classList.add('dark');
                updateDarkModeIcon();
            }
            
            // Actualizar estado de conexi칩n
            updateConnectionStatus();
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Guardar al cerrar
            window.addEventListener('beforeunload', () => save());
        };

        function updateConnectionStatus() {
            const status = document.getElementById('connection-status');
            if(navigator.onLine) {
                status.className = 'online';
                status.innerHTML = '游릭 Conectado';
            } else {
                status.className = 'offline';
                status.innerHTML = '游댮 Sin conexi칩n';
            }
        }

        // --- TEMA OSCURO ---
        function toggleDarkMode() {
            state.config.darkMode = !state.config.darkMode;
            document.body.classList.toggle('dark', state.config.darkMode);
            updateDarkModeIcon();
            save();
        }
        
        function updateDarkModeIcon() {
            const icon = document.querySelector('button[onclick="toggleDarkMode()"] i');
            if(icon) {
                icon.setAttribute('data-lucide', state.config.darkMode ? 'sun' : 'moon');
                lucide.createIcons();
            }
        }

        // --- NAVEGACI칍N ---
        function switchTab(tabId) {
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('section[id^="section-"]').forEach(s => {
                s.classList.add('hidden');
            });
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            
            if(tabId === 'dj') calculateDJ();
            if(tabId === 'taxes') renderTaxTable();
            if(tabId === 'reports') calculateReports();
        }

        // --- CALCULADORA ---
        function toggleEmployees() {
            state.config.hasEmployees = document.getElementById('has-employees').checked;
            document.getElementById('employee-inputs').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-work').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-ss').classList.toggle('hidden', !state.config.hasEmployees);
            calculateTaxes();
            save();
        }

        function calculateTaxes() {
            const income = parseFloat(document.getElementById('monthly-income')?.value) || 0;
            const empSalaries = parseFloat(document.getElementById('emp-salaries')?.value) || 0;
            const cess = parseFloat(document.getElementById('cess-scale')?.value) || 300;

            const vta = income * TAX_RATES.ventas;
            const personal = income * TAX_RATES.ingresos_personales;
            const work = state.config.hasEmployees ? (empSalaries * TAX_RATES.fuerza_trabajo) : 0;
            const ssEmpl = state.config.hasEmployees ? (empSalaries * TAX_RATES.seguridad_social_empleador) : 0;

            document.getElementById('res-sales').innerText = vta.toFixed(2);
            document.getElementById('res-personal').innerText = personal.toFixed(2);
            document.getElementById('res-work').innerText = work.toFixed(2);
            document.getElementById('res-ss-empl').innerText = ssEmpl.toFixed(2);
            document.getElementById('res-cess').innerText = cess.toFixed(2);

            const total = vta + personal + work + ssEmpl + cess;
            document.getElementById('res-total').innerText = total.toFixed(2);
            
            return { vta, personal, work, ssEmpl, cess, total };
        }

        // --- REGISTRAR IMPUESTOS ---
        function registerTaxPayment() {
            const clientId = document.getElementById('tax-client').value;
            if(!clientId) {
                Swal.fire('Error', 'Seleccione un cliente', 'error');
                return;
            }
            
            const client = state.clients.find(c => c.id == clientId);
            if(!client) {
                Swal.fire('Error', 'Cliente no encontrado', 'error');
                return;
            }
            
            const income = parseFloat(document.getElementById('monthly-income').value) || 0;
            
            if(income <= 0) {
                Swal.fire('Error', 'Ingrese ingresos v치lidos', 'error');
                return;
            }
            
            const taxes = calculateTaxes();
            
            const taxRecord = {
                id: Date.now(),
                clientId: client.id,
                clientName: client.name,
                date: new Date().toISOString().split('T')[0],
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                income: income,
                salesTax: taxes.vta,
                personalTax: taxes.personal,
                workTax: taxes.work,
                ssTax: taxes.ssEmpl,
                cess: taxes.cess,
                total: taxes.total,
                hasEmployees: state.config.hasEmployees
            };
            
            state.taxPayments.push(taxRecord);
            
            Swal.fire({
                icon: 'success',
                title: 'Registrado',
                text: `Impuesto de ${taxes.total.toFixed(2)} CUP registrado`,
                timer: 1500,
                showConfirmButton: false
            });
            
            save(true);
            
            document.getElementById('monthly-income').value = '';
            document.getElementById('emp-salaries').value = '';
            document.getElementById('tax-client').value = '';
            calculateTaxes();
        }

        // --- CLIENTES ---
        function updateClientSelects() {
            const selects = ['tax-client', 'dj-client', 'report-client', 'tax-filter-client'];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if(select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    
                    if(id === 'tax-filter-client') {
                        select.innerHTML = '<option value="all">Todos los clientes</option>';
                    } else if(id === 'dj-client' || id === 'report-client') {
                        select.innerHTML = '<option value="all">Todos los clientes</option>';
                    } else {
                        select.innerHTML = '<option value="">Seleccionar cliente...</option>';
                    }
                    
                    state.clients.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });
                    
                    if(currentValue && Array.from(select.options).some(opt => opt.value == currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        async function promptNewClient() {
            const { value: name } = await Swal.fire({
                title: 'Nuevo Cliente',
                input: 'text',
                inputLabel: 'Nombre del cliente',
                inputPlaceholder: 'Ej: Juan P칠rez',
                showCancelButton: true,
                inputValidator: (value) => !value && 'Escribe un nombre'
            });
            
            if(name) {
                const newId = Date.now();
                state.clients.push({ 
                    id: newId, 
                    name, 
                    movements: [] 
                });
                renderClients();
                updateClientSelects();
                selectClient(newId);
                save(true);
            }
        }

        function renderClients() {
            const container = document.getElementById('client-tags');
            if(!container) return;
            
            container.innerHTML = '';
            
            if(!state.clients || state.clients.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm">No hay clientes creados</p>';
                return;
            }
            
            state.clients.forEach(c => {
                const isActive = state.selectedClientId === c.id;
                const button = document.createElement('div');
                button.className = 'relative group inline-block mr-2 mb-2';
                
                button.innerHTML = `
                    <button onclick="selectClient(${c.id})" 
                            class="px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-all ${isActive ? 'bg-blue-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-300 border dark:border-slate-700'}">
                        ${c.name}
                    </button>
                `;
                
                container.appendChild(button);
            });
        }

        function selectClient(id) {
            state.selectedClientId = id;
            document.getElementById('no-client-hint').classList.add('hidden');
            document.getElementById('client-content').classList.remove('hidden');
            renderClients();
            renderMovements();
            updateClientSummary();
        }

        function renderMovements() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if(!client) return;
            
            const body = document.getElementById('movements-table-body');
            body.innerHTML = '';
            
            if(!client.movements || client.movements.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-400">No hay movimientos</td></tr>';
                return;
            }
            
            client.movements.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            client.movements.forEach(m => {
                body.innerHTML += `
                    <tr>
                        <td class="py-2">${m.date}</td>
                        <td class="py-2">${m.concept}</td>
                        <td class="py-2">
                            <span class="badge ${m.type === 'income' ? 'badge-success' : 'badge-warning'}">
                                ${m.type === 'income' ? 'Ingreso' : 'Gasto'}
                            </span>
                        </td>
                        <td class="py-2 text-right font-bold ${m.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${m.type === 'income' ? '+' : '-'}${m.amount.toFixed(2)}
                        </td>
                        <td class="py-2 text-center">
                            <button onclick="deleteMovement(${client.id}, ${m.id})" class="text-red-400 hover:text-red-600">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        function updateClientSummary() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if(!client) return;
            
            let income = 0, expense = 0;
            
            if(client.movements) {
                client.movements.forEach(m => {
                    if(m.type === 'income') income += m.amount;
                    else expense += m.amount;
                });
            }
            
            document.getElementById('client-income-total').innerText = income.toFixed(2);
            document.getElementById('client-expense-total').innerText = expense.toFixed(2);
            document.getElementById('client-balance').innerText = (income - expense).toFixed(2);
        }

        function addMovement() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if(!client) return;
            
            const type = document.getElementById('move-type').value;
            const concept = document.getElementById('move-concept').value;
            const amount = parseFloat(document.getElementById('move-amount').value);
            const date = document.getElementById('move-date').value;

            if(!concept || isNaN(amount) || amount <= 0) {
                Swal.fire('Error', 'Completa todos los campos', 'error');
                return;
            }

            if(!client.movements) client.movements = [];
            
            client.movements.unshift({
                id: Date.now(),
                date: date,
                type, 
                concept, 
                amount
            });

            document.getElementById('move-concept').value = '';
            document.getElementById('move-amount').value = '';
            
            renderMovements();
            updateClientSummary();
            save(true);
        }

        async function deleteMovement(clientId, movementId) {
            const result = await Swal.fire({
                title: '쮼liminar movimiento?',
                text: 'Esta acci칩n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S칤, eliminar'
            });
            
            if(result.isConfirmed) {
                const client = state.clients.find(c => c.id === clientId);
                if(client && client.movements) {
                    client.movements = client.movements.filter(m => m.id !== movementId);
                    renderMovements();
                    updateClientSummary();
                    save(true);
                }
            }
        }

        // --- IMPUESTOS ---
        function renderTaxTable() {
            const filterClient = document.getElementById('tax-filter-client').value;
            const filterMonth = document.getElementById('tax-filter-month').value;
            const filterYear = document.getElementById('tax-filter-year').value;
            
            let filtered = state.taxPayments ? [...state.taxPayments] : [];
            
            if(filterClient !== 'all') filtered = filtered.filter(t => t.clientId == filterClient);
            if(filterMonth !== 'all') filtered = filtered.filter(t => t.month == filterMonth);
            if(filterYear !== 'all') filtered = filtered.filter(t => t.year == filterYear);
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('tax-table-body');
            tbody.innerHTML = '';
            
            let totalSales = 0, totalPersonal = 0, totalWork = 0, totalSS = 0, totalCess = 0, totalAll = 0;
            
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-slate-400">No hay pagos</td></tr>';
            } else {
                filtered.forEach(t => {
                    totalSales += t.salesTax || 0;
                    totalPersonal += t.personalTax || 0;
                    totalWork += t.workTax || 0;
                    totalSS += t.ssTax || 0;
                    totalCess += t.cess || 0;
                    totalAll += t.total || 0;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td class="py-2">${t.date}</td>
                            <td class="py-2 font-medium">${t.clientName}</td>
                            <td class="py-2">Mensual</td>
                            <td class="py-2 text-right">${(t.salesTax||0).toFixed(2)}</td>
                            <td class="py-2 text-right">${(t.personalTax||0).toFixed(2)}</td>
                            <td class="py-2 text-right">${(t.workTax||0).toFixed(2)}</td>
                            <td class="py-2 text-right">${(t.ssTax||0).toFixed(2)}</td>
                            <td class="py-2 text-right">${(t.cess||0).toFixed(2)}</td>
                            <td class="py-2 text-right font-bold text-blue-600">${(t.total||0).toFixed(2)}</td>
                            <td class="py-2 text-center">
                                <button onclick="deleteTaxPayment(${t.id})" class="text-red-400 hover:text-red-600">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('tax-total-sales').innerText = totalSales.toFixed(2);
            document.getElementById('tax-total-personal').innerText = totalPersonal.toFixed(2);
            document.getElementById('tax-total-cess').innerText = totalCess.toFixed(2);
            document.getElementById('tax-total-amount').innerText = totalAll.toFixed(2);
            
            document.getElementById('tax-table-footer').innerHTML = `
                <tr>
                    <td colspan="3" class="py-2 text-right font-bold">TOTALES:</td>
                    <td class="py-2 text-right font-bold">${totalSales.toFixed(2)}</td>
                    <td class="py-2 text-right font-bold">${totalPersonal.toFixed(2)}</td>
                    <td class="py-2 text-right font-bold">${totalWork.toFixed(2)}</td>
                    <td class="py-2 text-right font-bold">${totalSS.toFixed(2)}</td>
                    <td class="py-2 text-right font-bold">${totalCess.toFixed(2)}</td>
                    <td class="py-2 text-right font-bold text-blue-600">${totalAll.toFixed(2)}</td>
                    <td></td>
                </tr>
            `;
            
            lucide.createIcons();
        }

        function filterTaxes() {
            renderTaxTable();
        }

        async function deleteTaxPayment(id) {
            const result = await Swal.fire({
                title: '쮼liminar pago?',
                text: 'Esta acci칩n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S칤, eliminar'
            });
            
            if(result.isConfirmed) {
                state.taxPayments = state.taxPayments.filter(t => t.id !== id);
                renderTaxTable();
                save(true);
            }
        }

        function exportTaxesCSV() {
            if(!state.taxPayments || state.taxPayments.length === 0) {
                Swal.fire('Info', 'No hay datos para exportar', 'info');
                return;
            }
            
            let csv = 'Fecha,Cliente,Ingresos,Ventas,Personal,F.Trabajo,SS Empl,CESS,Total\n';
            state.taxPayments.forEach(t => {
                csv += `${t.date},${t.clientName},${t.income||0},${t.salesTax||0},${t.personalTax||0},${t.workTax||0},${t.ssTax||0},${t.cess||0},${t.total||0}\n`;
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `impuestos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // --- DJ ANUAL ---
        function calculateDJ() {
            const clientId = document.getElementById('dj-client').value;
            const year = parseInt(document.getElementById('dj-year').value);
            
            let totalI = 0, totalE = 0;
            
            state.clients.forEach(c => {
                if(clientId !== 'all' && c.id != clientId) return;
                
                if(c.movements) {
                    c.movements.forEach(m => {
                        const mYear = new Date(m.date).getFullYear();
                        if(mYear === year) {
                            if(m.type === 'income') totalI += m.amount;
                            else totalE += m.amount;
                        }
                    });
                }
            });

            const net = totalI - totalE;
            const base = Math.max(0, net - 39120);
            
            let tax = 0;
            for(let i = TAX_BRACKETS.length - 1; i >= 0; i--) {
                if(net > TAX_BRACKETS[i].min) {
                    const taxable = Math.min(net, TAX_BRACKETS[i].max) - TAX_BRACKETS[i].min;
                    tax = TAX_BRACKETS[i].base + (taxable * TAX_BRACKETS[i].rate);
                    break;
                }
            }

            document.getElementById('dj-incomes').innerText = totalI.toFixed(2);
            document.getElementById('dj-expenses').innerText = totalE.toFixed(2);
            document.getElementById('dj-net').innerText = net.toFixed(2);
            document.getElementById('dj-base').innerText = base.toFixed(2);
            document.getElementById('dj-tax').innerText = tax.toFixed(2);
        }

        function generatePDF() {
            Swal.fire('Info', 'Funci칩n PDF pr칩ximamente', 'info');
        }

        // --- REPORTES ---
        function calculateReports() {
            let totalClients = state.clients.length;
            let totalMovements = 0;
            let totalIncome = 0;
            let totalExpense = 0;
            
            state.clients.forEach(c => {
                if(c.movements) {
                    totalMovements += c.movements.length;
                    c.movements.forEach(m => {
                        if(m.type === 'income') totalIncome += m.amount;
                        else totalExpense += m.amount;
                    });
                }
            });
            
            document.getElementById('report-total-clients').innerText = totalClients;
            document.getElementById('report-total-movements').innerText = totalMovements;
            document.getElementById('report-total-income').innerText = totalIncome.toFixed(2);
            document.getElementById('report-total-expense').innerText = totalExpense.toFixed(2);
            document.getElementById('report-net').innerText = (totalIncome - totalExpense).toFixed(2);
            
            // Desglose por cliente
            const breakdown = document.getElementById('report-client-breakdown');
            breakdown.innerHTML = '';
            
            state.clients.forEach(c => {
                let clientIncome = 0, clientExpense = 0;
                if(c.movements) {
                    c.movements.forEach(m => {
                        if(m.type === 'income') clientIncome += m.amount;
                        else clientExpense += m.amount;
                    });
                }
                
                const clientTaxes = state.taxPayments?.filter(t => t.clientId === c.id).reduce((sum, t) => sum + t.total, 0) || 0;
                
                breakdown.innerHTML += `
                    <tr>
                        <td class="py-2">${c.name}</td>
                        <td class="py-2 text-right text-green-600">${clientIncome.toFixed(2)}</td>
                        <td class="py-2 text-right text-red-600">${clientExpense.toFixed(2)}</td>
                        <td class="py-2 text-right text-blue-600">${(clientIncome - clientExpense).toFixed(2)}</td>
                        <td class="py-2 text-right text-purple-600">${clientTaxes.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Gr치ficos
            createCharts(totalIncome, totalExpense, state.taxPayments || []);
        }

        function createCharts(income, expense, taxPayments) {
            if(incomeExpenseChart) incomeExpenseChart.destroy();
            if(taxBreakdownChart) taxBreakdownChart.destroy();
            
            const ctx1 = document.getElementById('incomeExpenseChart')?.getContext('2d');
            if(ctx1) {
                incomeExpenseChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Ingresos', 'Gastos', 'Balance'],
                        datasets: [{
                            label: 'Monto (CUP)',
                            data: [income, expense, income - expense],
                            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            const taxBreakdown = {
                sales: taxPayments.reduce((sum, t) => sum + (t.salesTax || 0), 0),
                personal: taxPayments.reduce((sum, t) => sum + (t.personalTax || 0), 0),
                work: taxPayments.reduce((sum, t) => sum + (t.workTax || 0), 0),
                ss: taxPayments.reduce((sum, t) => sum + (t.ssTax || 0), 0),
                cess: taxPayments.reduce((sum, t) => sum + (t.cess || 0), 0)
            };
            
            const ctx2 = document.getElementById('taxBreakdownChart')?.getContext('2d');
            if(ctx2) {
                taxBreakdownChart = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Ventas', 'Personal', 'F. Trabajo', 'SS Empl', 'CESS'],
                        datasets: [{
                            data: [taxBreakdown.sales, taxBreakdown.personal, taxBreakdown.work, taxBreakdown.ss, taxBreakdown.cess],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        // --- RESPALDOS ---
        function createBackup() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_manual_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            Swal.fire('Respaldo creado', 'Archivo descargado', 'success');
        }

        function restoreFromBackup() {
            const backups = [];
            for(let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key && key.startsWith('tcp_backup_')) {
                    backups.push(key);
                }
            }
            
            if(backups.length === 0) {
                Swal.fire('No hay respaldos', 'No se encontraron respaldos autom치ticos', 'info');
                return;
            }
            
            let options = '<select id="backup-select" class="input-field">';
            backups.sort().reverse().forEach(key => {
                const date = key.replace('tcp_backup_', '');
                options += `<option value="${key}">${date}</option>`;
            });
            options += '</select>';
            
            Swal.fire({
                title: 'Restaurar respaldo',
                html: options,
                confirmButtonText: 'Restaurar',
                showCancelButton: true,
                preConfirm: () => {
                    const key = document.getElementById('backup-select').value;
                    const backupData = localStorage.getItem(key);
                    if(backupData) {
                        state = JSON.parse(backupData);
                        save(true);
                        location.reload();
                    }
                }
            });
        }

        function showBackupList() {
            const backups = [];
            for(let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key && key.startsWith('tcp_backup_')) {
                    backups.push(key);
                }
            }
            
            if(backups.length === 0) {
                Swal.fire('No hay respaldos', 'No se encontraron respaldos autom치ticos', 'info');
                return;
            }
            
            let html = '<div class="text-left max-h-60 overflow-y-auto">';
            backups.sort().reverse().forEach(key => {
                const date = key.replace('tcp_backup_', '');
                html += `<div class="p-2 border-b flex justify-between items-center">
                    <span>游늰 ${date}</span>
                    <button onclick="loadBackup('${key}')" class="text-blue-600 text-xs">Cargar</button>
                </div>`;
            });
            html += '</div>';
            
            Swal.fire({
                title: 'Respaldos disponibles',
                html: html,
                confirmButtonText: 'Cerrar'
            });
        }

        window.loadBackup = function(key) {
            const backupData = localStorage.getItem(key);
            if(backupData) {
                state = JSON.parse(backupData);
                save(true);
                location.reload();
            }
        };

        // --- IMPORT/EXPORT ---
        function exportData() {
            createBackup();
        }

        async function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            try {
                const text = await file.text();
                const imported = JSON.parse(text);
                
                const result = await Swal.fire({
                    title: '쯀mportar datos?',
                    text: 'Se reemplazar치n todos los datos actuales',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'S칤, importar'
                });
                
                if(result.isConfirmed) {
                    state = imported;
                    save();
                    location.reload();
                }
            } catch(error) {
                Swal.fire('Error', 'Archivo inv치lido', 'error');
            }
            e.target.value = '';
        }
    </script>
</body>
</html>
