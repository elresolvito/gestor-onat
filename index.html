import React, { useState, useEffect, useMemo } from 'react';
import { 
  Calculator, 
  Users, 
  FileText, 
  FolderOpen, 
  Save, 
  Plus, 
  Trash2, 
  ChevronRight, 
  ChevronDown, 
  Download,
  Cloud,
  Moon,
  Sun,
  DollarSign,
  TrendingUp,
  Briefcase
} from 'lucide-react';

// --- CONSTANTES TRIBUTARIAS (Basadas en normativas actuales) ---
const TAX_RATES = {
  ventas_servicios: 0.10, // 10%
  ingresos_personales_mensual: 0.05, // 5% a cuenta
  seguridad_social_empleador: 0.14, // 14%
  fuerza_trabajo: 0.05, // 5%
};

const ESCALAS_SS = [
  { base: 2000, cuota: 400 },
  { base: 2500, cuota: 500 },
  { base: 3000, cuota: 600 },
  { base: 3500, cuota: 700 },
  { base: 4000, cuota: 800 },
  { base: 4500, cuota: 900 },
  { base: 5000, cuota: 1000 },
];

const ESCALAS_DJ = [
  { limite: 30000, tipo: 0.15, acumulado: 0 },
  { limite: 50000, tipo: 0.20, acumulado: 4500 },
  { limite: 100000, tipo: 0.25, acumulado: 8500 },
  { limite: 150000, tipo: 0.35, acumulado: 21000 },
  { limite: Infinity, tipo: 0.50, acumulado: 38500 }
];

const App = () => {
  // --- ESTADO GLOBAL ---
  const [activeTab, setActiveTab] = useState('calculadora');
  const [darkMode, setDarkMode] = useState(false);
  const [data, setData] = useState(() => {
    const saved = localStorage.getItem('tcp_data');
    return saved ? JSON.parse(saved) : {
      perfil: { nombre: '', nit: '' },
      empleados: [],
      registros: [], // { id, fecha, cliente, tipo, concepto, monto }
      clientes: ['General'],
      config: { tieneEmpleados: false }
    };
  });

  // --- PERSISTENCIA ---
  useEffect(() => {
    localStorage.setItem('tcp_data', JSON.stringify(data));
  }, [data]);

  // --- LÓGICA DE CÁLCULO ---
  const calculations = useMemo(() => {
    const ingresosMes = data.registros
      .filter(r => r.tipo === 'ingreso')
      .reduce((acc, curr) => acc + parseFloat(curr.monto || 0), 0);
    
    const gastosMes = data.registros
      .filter(r => r.tipo === 'gasto')
      .reduce((acc, curr) => acc + parseFloat(curr.monto || 0), 0);

    const salariosTotal = data.empleados.reduce((acc, curr) => acc + parseFloat(curr.salario || 0), 0);
    
    const impVentas = ingresosMes * TAX_RATES.ventas_servicios;
    const impFuerzaTrabajo = data.config.tieneEmpleados ? salariosTotal * TAX_RATES.fuerza_trabajo : 0;
    const impSeguridadSocial = data.config.tieneEmpleados ? salariosTotal * TAX_RATES.seguridad_social_empleador : 0;
    const pagoAnticipado = ingresosMes * TAX_RATES.ingresos_personales_mensual;

    return {
      ingresosMes,
      gastosMes,
      salariosTotal,
      impVentas,
      impFuerzaTrabajo,
      impSeguridadSocial,
      pagoAnticipado,
      totalPagar: impVentas + impFuerzaTrabajo + impSeguridadSocial + pagoAnticipado
    };
  }, [data]);

  // --- COMPONENTES DE INTERFAZ ---
  const TabButton = ({ id, icon: Icon, label }) => (
    <button
      onClick={() => setActiveTab(id)}
      className={`flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 ${
        activeTab === id 
          ? 'bg-blue-600 text-white shadow-lg scale-105' 
          : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800'
      }`}
    >
      <Icon size={20} />
      <span className="text-[10px] mt-1 font-medium uppercase tracking-wider">{label}</span>
    </button>
  );

  const SectionTitle = ({ title, subtitle }) => (
    <div className="mb-6">
      <h2 className="text-2xl font-bold text-gray-800 dark:text-white">{title}</h2>
      <p className="text-sm text-gray-500 dark:text-gray-400">{subtitle}</p>
    </div>
  );

  // --- VISTAS ---
  
  const CalculadoraView = () => (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <Briefcase className="text-blue-500" /> Configuración de Actividad
          </h3>
          <div className="space-y-4">
            <div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
              <span>¿Tiene empleados contratados?</span>
              <button 
                onClick={() => setData({...data, config: {...data.config, tieneEmpleados: !data.config.tieneEmpleados}})}
                className={`w-12 h-6 rounded-full transition-colors relative ${data.config.tieneEmpleados ? 'bg-green-500' : 'bg-gray-300'}`}
              >
                <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${data.config.tieneEmpleados ? 'translate-x-7' : 'translate-x-1'}`} />
              </button>
            </div>
            <div className="p-4 border border-blue-100 dark:border-blue-900 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
              <div className="flex justify-between text-sm mb-1 text-blue-800 dark:text-blue-300">
                <span>Ingresos Brutos (Mes):</span>
                <span className="font-mono">${calculations.ingresosMes.toFixed(2)}</span>
              </div>
              <p className="text-[10px] text-blue-600 dark:text-blue-400">Calculado automáticamente desde tus registros.</p>
            </div>
          </div>
        </div>

        <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-2xl shadow-xl text-white">
          <h3 className="text-lg font-medium opacity-90 mb-4 uppercase tracking-tighter">Resumen de Impuestos a Pagar</h3>
          <div className="space-y-3">
            <div className="flex justify-between border-b border-white/10 pb-2">
              <span className="text-sm">Ventas/Servicios (10%)</span>
              <span className="font-mono">${calculations.impVentas.toFixed(2)}</span>
            </div>
            <div className="flex justify-between border-b border-white/10 pb-2">
              <span className="text-sm">Ingresos Personales (5%)</span>
              <span className="font-mono">${calculations.pagoAnticipado.toFixed(2)}</span>
            </div>
            {data.config.tieneEmpleados && (
              <>
                <div className="flex justify-between border-b border-white/10 pb-2">
                  <span className="text-sm">Util. Fuerza Trabajo (5%)</span>
                  <span className="font-mono">${calculations.impFuerzaTrabajo.toFixed(2)}</span>
                </div>
                <div className="flex justify-between border-b border-white/10 pb-2">
                  <span className="text-sm">Seguridad Social (14%)</span>
                  <span className="font-mono">${calculations.impSeguridadSocial.toFixed(2)}</span>
                </div>
              </>
            )}
            <div className="flex justify-between pt-2 text-xl font-bold">
              <span>TOTAL</span>
              <span className="font-mono">${calculations.totalPagar.toFixed(2)}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  const RegistrosView = () => {
    const [newItem, setNewItem] = useState({ tipo: 'ingreso', cliente: 'General', concepto: '', monto: '' });
    
    const addRegistro = () => {
      if(!newItem.concepto || !newItem.monto) return;
      setData({
        ...data,
        registros: [...data.registros, { ...newItem, id: Date.now(), fecha: new Date().toLocaleDateString() }]
      });
      setNewItem({ tipo: 'ingreso', cliente: 'General', concepto: '', monto: '' });
    };

    return (
      <div className="space-y-6">
        <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
          <h3 className="text-lg font-semibold mb-4">Nuevo Movimiento</h3>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-3">
            <select 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500"
              value={newItem.tipo}
              onChange={(e) => setNewItem({...newItem, tipo: e.target.value})}
            >
              <option value="ingreso">Ingreso (+)</option>
              <option value="gasto">Gasto (-)</option>
            </select>
            <select 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500"
              value={newItem.cliente}
              onChange={(e) => setNewItem({...newItem, cliente: e.target.value})}
            >
              {data.clientes.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <input 
              type="text" placeholder="Concepto" 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500 md:col-span-2"
              value={newItem.concepto}
              onChange={(e) => setNewItem({...newItem, concepto: e.target.value})}
            />
            <input 
              type="number" placeholder="Monto $" 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500"
              value={newItem.monto}
              onChange={(e) => setNewItem({...newItem, monto: e.target.value})}
            />
          </div>
          <button 
            onClick={addRegistro}
            className="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg"
          >
            <Plus size={20} /> Registrar Operación
          </button>
        </div>

        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm overflow-hidden">
          <div className="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-900/50">
            <h3 className="font-semibold">Historial de Operaciones</h3>
            <div className="flex gap-2">
              <button 
                onClick={() => {
                  const nombre = prompt("Nombre del nuevo cliente:");
                  if(nombre) setData({...data, clientes: [...data.clientes, nombre]});
                }}
                className="text-xs text-blue-600 font-bold hover:underline"
              >
                + Nuevo Cliente
              </button>
            </div>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left">
              <thead>
                <tr className="text-xs text-gray-400 uppercase tracking-widest bg-gray-50 dark:bg-gray-900">
                  <th className="p-4">Fecha</th>
                  <th className="p-4">Cliente</th>
                  <th className="p-4">Concepto</th>
                  <th className="p-4 text-right">Monto</th>
                  <th className="p-4"></th>
                </tr>
              </thead>
              <tbody className="divide-y dark:divide-gray-700">
                {data.registros.length === 0 && (
                  <tr><td colSpan="5" className="p-10 text-center text-gray-400">No hay registros aún</td></tr>
                )}
                {[...data.registros].reverse().map(reg => (
                  <tr key={reg.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td className="p-4 text-xs font-medium">{reg.fecha}</td>
                    <td className="p-4"><span className="px-2 py-1 bg-gray-100 dark:bg-gray-900 rounded-md text-[10px] uppercase">{reg.cliente}</span></td>
                    <td className="p-4 text-sm">{reg.concepto}</td>
                    <td className={`p-4 text-right font-mono font-bold ${reg.tipo === 'ingreso' ? 'text-green-500' : 'text-red-500'}`}>
                      {reg.tipo === 'ingreso' ? '+' : '-'}${parseFloat(reg.monto).toFixed(2)}
                    </td>
                    <td className="p-4">
                      <button 
                        onClick={() => setData({...data, registros: data.registros.filter(r => r.id !== reg.id)})}
                        className="text-gray-300 hover:text-red-500 transition-colors"
                      >
                        <Trash2 size={16} />
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  };

  const EmpleadosView = () => {
    const [newEmp, setNewEmp] = useState({ nombre: '', salario: '', escala: 400 });

    const addEmpleado = () => {
      if(!newEmp.nombre || !newEmp.salario) return;
      setData({
        ...data,
        empleados: [...data.empleados, { ...newEmp, id: Date.now() }]
      });
      setNewEmp({ nombre: '', salario: '', escala: 400 });
    };

    return (
      <div className="space-y-6">
        <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
          <h3 className="text-lg font-semibold mb-4">Contratar Empleado</h3>
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <input 
              type="text" placeholder="Nombre completo" 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500"
              value={newEmp.nombre}
              onChange={(e) => setNewEmp({...newEmp, nombre: e.target.value})}
            />
            <input 
              type="number" placeholder="Salario Pactado $" 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500"
              value={newEmp.salario}
              onChange={(e) => setNewEmp({...newEmp, salario: e.target.value})}
            />
            <select 
              className="p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 ring-blue-500"
              value={newEmp.escala}
              onChange={(e) => setNewEmp({...newEmp, escala: parseInt(e.target.value)})}
            >
              {ESCALAS_SS.map(e => (
                <option key={e.base} value={e.cuota}>Base ${e.base} / Cuota ${e.cuota}</option>
              ))}
            </select>
          </div>
          <button 
            onClick={addEmpleado}
            className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-transform active:scale-95"
          >
            <Users size={20} /> Añadir a Nómina
          </button>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {data.empleados.map(emp => (
            <div key={emp.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-indigo-500 flex justify-between items-center">
              <div>
                <h4 className="font-bold">{emp.nombre}</h4>
                <p className="text-xs text-gray-500">Salario: ${emp.salario} | SS: ${emp.escala}</p>
              </div>
              <button 
                onClick={() => setData({...data, empleados: data.empleados.filter(e => e.id !== emp.id)})}
                className="text-red-200 hover:text-red-500"
              >
                <Trash2 size={18} />
              </button>
            </div>
          ))}
        </div>
      </div>
    );
  };

  const DJView = () => {
    const totalIngresosAnual = data.registros.filter(r => r.tipo === 'ingreso').reduce((a, b) => a + parseFloat(b.monto), 0);
    const totalGastosAnual = data.registros.filter(r => r.tipo === 'gasto').reduce((a, b) => a + parseFloat(b.monto), 0);
    const pagosAnticipadosRealizados = totalIngresosAnual * TAX_RATES.ingresos_personales_mensual;
    
    // Simplificación de cálculo de DJ según escala progresiva cubana
    const baseImponible = Math.max(0, totalIngresosAnual - (totalIngresosAnual * 0.20) - totalGastosAnual); // 20% exento mínimo
    
    let impuestoDJ = 0;
    for (let tramo of ESCALAS_DJ) {
      if (baseImponible <= tramo.limite) {
        impuestoDJ = (baseImponible * tramo.tipo) - tramo.acumulado;
        break;
      }
    }
    const aPagarLiquidacion = Math.max(0, impuestoDJ - pagosAnticipadosRealizados);

    return (
      <div className="space-y-6">
        <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-orange-100 dark:border-orange-900">
          <h3 className="text-xl font-bold mb-6 text-orange-600 flex items-center gap-2">
            <FileText /> Pre-Cálculo Declaración Jurada (DJ-08)
          </h3>
          <div className="space-y-4 max-w-2xl">
            <div className="flex justify-between items-center py-2 border-b dark:border-gray-700">
              <span className="text-gray-600 dark:text-gray-400 italic">Total Ingresos Brutos Anuales:</span>
              <span className="font-bold text-lg">${totalIngresosAnual.toFixed(2)}</span>
            </div>
            <div className="flex justify-between items-center py-2 border-b dark:border-gray-700">
              <span className="text-gray-600 dark:text-gray-400 italic">Gastos Deducibles (Justificados):</span>
              <span className="font-bold text-lg text-red-500">${totalGastosAnual.toFixed(2)}</span>
            </div>
            <div className="flex justify-between items-center py-4 bg-gray-50 dark:bg-gray-900 px-4 rounded-xl">
              <span className="font-bold">Base Imponible Estimada:</span>
              <span className="font-bold text-xl text-blue-600 font-mono">${baseImponible.toFixed(2)}</span>
            </div>
            <div className="flex justify-between items-center py-2 border-b dark:border-gray-700">
              <span className="text-gray-600 dark:text-gray-400">Impuesto Calculado (Escala Progresiva):</span>
              <span>${impuestoDJ.toFixed(2)}</span>
            </div>
            <div className="flex justify-between items-center py-2 border-b dark:border-gray-700">
              <span className="text-gray-600 dark:text-gray-400">Menos Pagos Anticipados (5%):</span>
              <span className="text-green-600">-${pagosAnticipadosRealizados.toFixed(2)}</span>
            </div>
            <div className="mt-8 p-6 bg-orange-600 text-white rounded-2xl shadow-xl flex justify-between items-center">
              <div>
                <p className="text-xs uppercase font-bold opacity-80">Importe a Liquidar en la ONAT</p>
                <h4 className="text-3xl font-black">${aPagarLiquidacion.toFixed(2)}</h4>
              </div>
              <div className="text-right">
                <p className="text-[10px] leading-tight opacity-70">Este valor es una estimación basada en los <br/>registros actuales del año fiscal.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const ConfigView = () => (
    <div className="space-y-6">
      <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
        <SectionTitle title="Ajustes y Nube" subtitle="Gestiona tus datos y sincronización" />
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <button 
            onClick={() => {
              const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
              const downloadAnchorNode = document.createElement('a');
              downloadAnchorNode.setAttribute("href", dataStr);
              downloadAnchorNode.setAttribute("download", `backup_tcp_${new Date().toLocaleDateString()}.json`);
              document.body.appendChild(downloadAnchorNode);
              downloadAnchorNode.click();
              downloadAnchorNode.remove();
            }}
            className="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors border border-transparent hover:border-blue-200"
          >
            <Download className="text-blue-500" />
            <div className="text-left">
              <p className="font-bold text-sm">Exportar Backup</p>
              <p className="text-xs text-gray-500">Guarda un archivo con tus datos</p>
            </div>
          </button>
          
          <button 
            className="flex items-center gap-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-xl hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors border border-transparent hover:border-green-200"
            onClick={() => alert("Sincronización con Google Drive: En una versión instalada como App, podrías usar la API de Drive para subir el archivo .json generado.")}
          >
            <Cloud className="text-green-500" />
            <div className="text-left">
              <p className="font-bold text-sm">Sincronizar Nube</p>
              <p className="text-xs text-gray-500">Google Drive / OneDrive</p>
            </div>
          </button>
        </div>

        <div className="mt-8">
          <h4 className="text-sm font-bold text-red-500 mb-4 uppercase tracking-tighter">Zona Peligrosa</h4>
          <button 
            onClick={() => {
              if(window.confirm("¿Borrar todos los datos? Esta acción no se puede deshacer.")) {
                setData({ perfil: { nombre: '', nit: '' }, empleados: [], registros: [], clientes: ['General'], config: { tieneEmpleados: false } });
                localStorage.clear();
              }
            }}
            className="flex items-center gap-2 text-xs text-red-600 hover:bg-red-50 p-2 rounded-lg"
          >
            <Trash2 size={14} /> Borrar toda la base de datos
          </button>
        </div>
      </div>
    </div>
  );

  return (
    <div className={`min-h-screen transition-colors duration-300 ${darkMode ? 'bg-gray-950 text-white' : 'bg-gray-50 text-gray-900'}`}>
      
      {/* HEADER */}
      <header className="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b dark:border-gray-800 p-4">
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="bg-blue-600 p-2 rounded-lg text-white">
              <Calculator size={24} />
            </div>
            <div>
              <h1 className="text-lg font-black tracking-tighter leading-none">TAX CUBA <span className="text-blue-600 text-xs">TCP</span></h1>
              <p className="text-[10px] text-gray-500 uppercase font-bold">Gestión Tributaria Inteligente</p>
            </div>
          </div>
          <button 
            onClick={() => setDarkMode(!darkMode)}
            className="p-2 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500"
          >
            {darkMode ? <Sun size={20} /> : <Moon size={20} />}
          </button>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <main className="max-w-5xl mx-auto p-4 pb-32">
        {activeTab === 'calculadora' && <CalculadoraView />}
        {activeTab === 'registros' && <RegistrosView />}
        {activeTab === 'empleados' && <EmpleadosView />}
        {activeTab === 'dj' && <DJView />}
        {activeTab === 'config' && <ConfigView />}
      </main>

      {/* BOTTOM NAVIGATION (Optimizado para móvil) */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t dark:border-gray-800 p-2 pb-6 sm:pb-2 z-40">
        <div className="max-w-lg mx-auto grid grid-cols-5 gap-1">
          <TabButton id="calculadora" icon={Calculator} label="Tributos" />
          <TabButton id="registros" icon={FolderOpen} label="Libros" />
          <TabButton id="empleados" icon={Users} label="Nómina" />
          <TabButton id="dj" icon={FileText} label="DJ" />
          <TabButton id="config" icon={Cloud} label="Nube" />
        </div>
      </nav>

      {/* OFFLINE INDICATOR */}
      <div className="fixed top-20 right-4 pointer-events-none">
        <div className="flex items-center gap-1 bg-green-500/10 text-green-500 text-[10px] px-2 py-1 rounded-full border border-green-500/20 font-bold uppercase">
          <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse" />
          Offline Ready
        </div>
      </div>
    </div>
  );
};

export default App;