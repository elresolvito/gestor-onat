<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestor Fiscal TCP Pro | Onat</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestor TCP">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS via CDN (CORREGIDO) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SweetAlert2 y Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        body.dark {
            background: linear-gradient(135deg, #1a1c2c 0%, #2d1f3a 100%);
        }

        #app {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .glass-card {
            background: rgba(18, 24, 38, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.4);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Navigation Tabs */
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #4a5568;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .dark .nav-tab {
            background: rgba(26, 32, 44, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e0;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            transform: scale(1.02);
            box-shadow: 0 10px 30px -5px rgba(102, 126, 234, 0.5);
        }

        .dark .nav-tab.active {
            background: linear-gradient(135deg, #4c51bf 0%, #6b46c1 100%);
            box-shadow: 0 10px 30px -5px rgba(76, 81, 191, 0.5);
        }

        /* Input Fields */
        .input-field {
            width: 100%;
            padding: 0.875rem 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            color: #1a202c;
            font-weight: 500;
        }

        .dark .input-field {
            background: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .input-field:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Modern Toggle Switch */
        .toggle-switch {
            width: 56px;
            height: 32px;
            background: #cbd5e0;
            border-radius: 99px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark .toggle-switch {
            background: #4a5568;
        }

        .toggle-dot {
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .toggle-switch {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .toggle-switch .toggle-dot {
            transform: translateX(24px);
        }

        /* Modern Table */
        .table-container {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .dark .table-container {
            background: #1e293b;
            border: 1px solid #334155;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            padding: 1rem 0.75rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .dark th {
            background: #0f172a;
            color: #94a3b8;
            border-bottom-color: #334155;
        }

        td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }

        .dark td {
            border-bottom-color: #334155;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #22c55e;
            color: white;
        }

        .badge-warning {
            background: #f59e0b;
            color: white;
        }

        .badge-info {
            background: #3b82f6;
            color: white;
        }

        /* Connection Status */
        #connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .online {
            background: #10b981;
            color: white;
        }

        .offline {
            background: #ef4444;
            color: white;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        /* Responsive */
        @media (max-width: 640px) {
            #app {
                padding: 1rem;
            }
            
            .glass-card {
                border-radius: 20px;
                padding: 1.25rem;
            }
            
            .nav-tab span {
                font-size: 0.65rem;
            }
        }

        /* Utilidades adicionales de Tailwind */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Connection Status -->
    <div id="connection-status" class="online">ðŸŸ¢ Conectado</div>
    
    <div id="app">
        <!-- Header with Logo -->
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg transform hover:rotate-6 transition-transform">
                    <svg width="28" height="28" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 16L14 22L24 10" stroke="white" stroke-width="3" stroke-linecap="round"/>
                        <circle cx="24" cy="8" r="2" fill="white"/>
                        <circle cx="8" cy="24" r="2" fill="white"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-white">Gestor Fiscal</h1>
                    <p class="text-xs text-white/80 font-medium">TCP Pro Â· Onat</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <!-- Save Indicator -->
                <div id="save-indicator" class="flex items-center gap-2 px-4 py-2 bg-white/90 backdrop-blur-sm rounded-xl text-sm font-medium shadow-lg">
                    <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                    <span>Guardado</span>
                </div>
                
                <!-- Theme Toggle -->
                <button onclick="toggleDarkMode()" class="w-10 h-10 bg-white/90 backdrop-blur-sm rounded-xl flex items-center justify-center hover:scale-110 transition-transform shadow-lg">
                    <i data-lucide="moon" class="w-5 h-5 text-gray-700"></i>
                </button>
                
                <!-- Export -->
                <button onclick="exportData()" class="w-10 h-10 bg-white/90 backdrop-blur-sm rounded-xl flex items-center justify-center hover:scale-110 transition-transform shadow-lg">
                    <i data-lucide="download" class="w-5 h-5 text-gray-700"></i>
                </button>
                
                <!-- Import -->
                <label class="w-10 h-10 bg-white/90 backdrop-blur-sm rounded-xl flex items-center justify-center hover:scale-110 transition-transform cursor-pointer shadow-lg">
                    <i data-lucide="upload" class="w-5 h-5 text-gray-700"></i>
                    <input type="file" class="hidden" onchange="importData(event)" accept=".json">
                </label>
                
                <!-- Backup -->
                <button onclick="createBackup()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2 shadow-lg">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Respaldo
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="grid grid-cols-5 gap-3 mb-8">
            <button onclick="switchTab('calc')" id="tab-calc" class="nav-tab active">
                <i data-lucide="calculator" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Calculadora</span>
            </button>
            <button onclick="switchTab('records')" id="tab-records" class="nav-tab">
                <i data-lucide="users" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Clientes</span>
            </button>
            <button onclick="switchTab('taxes')" id="tab-taxes" class="nav-tab">
                <i data-lucide="receipt" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Impuestos</span>
            </button>
            <button onclick="switchTab('dj')" id="tab-dj" class="nav-tab">
                <i data-lucide="file-text" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">DJ Anual</span>
            </button>
            <button onclick="switchTab('reports')" id="tab-reports" class="nav-tab">
                <i data-lucide="bar-chart-2" class="mb-1 w-5 h-5"></i>
                <span class="text-xs font-bold">Reportes</span>
            </button>
        </nav>

        <!-- SECTION 1: CALCULATOR -->
        <section id="section-calc">
            <div class="glass-card p-6 mb-6">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-indigo-500"></i>
                    ConfiguraciÃ³n de Actividad
                </h2>
                
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-2xl mb-6">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Â¿Tiene empleados contratados?</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="has-employees" class="sr-only" onchange="toggleEmployees()">
                        <div class="toggle-switch">
                            <div class="toggle-dot"></div>
                        </div>
                    </label>
                </div>

                <div id="employee-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Cant. Empleados</label>
                        <input type="number" id="emp-count" oninput="calculateTaxes()" class="input-field" value="1" min="1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Total Salarios (CUP)</label>
                        <input type="number" id="emp-salaries" oninput="calculateTaxes()" class="input-field" placeholder="0.00" min="0" step="100" value="0">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Ingresos Brutos (Mes)</label>
                        <input type="number" id="monthly-income" oninput="calculateTaxes()" class="input-field" placeholder="0.00" min="0" step="100" value="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Seguridad Social (CESS)</label>
                        <select id="cess-scale" onchange="calculateTaxes()" class="input-field">
                            <option value="300">Escala 2000 (Cuota 300)</option>
                            <option value="450">Escala 3000 (Cuota 450)</option>
                            <option value="750">Escala 5000 (Cuota 750)</option>
                            <option value="1500">Escala 10000 (Cuota 1500)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Cliente</label>
                        <select id="tax-client" class="input-field">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="registerTaxPayment()" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Registrar Pago de Impuestos
                    </button>
                </div>
            </div>

            <!-- Tax Summary -->
            <div class="glass-card p-6 border-l-4 border-indigo-500">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="receipt" class="w-5 h-5 text-indigo-500"></i>
                    Resumen de Impuestos a Pagar
                </h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gradient-to-r from-indigo-50 to-transparent dark:from-indigo-900/10 rounded-xl">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Ventas/Servicios (10%):</span>
                        <span id="res-sales" class="font-bold text-lg text-gray-800 dark:text-white">0.00</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gradient-to-r from-purple-50 to-transparent dark:from-purple-900/10 rounded-xl">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Ingresos Personales (5%):</span>
                        <span id="res-personal" class="font-bold text-lg text-gray-800 dark:text-white">0.00</span>
                    </div>
                    <div id="row-work" class="hidden flex justify-between items-center p-3 bg-gradient-to-r from-pink-50 to-transparent dark:from-pink-900/10 rounded-xl">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Util. Fuerza Trabajo (5%):</span>
                        <span id="res-work" class="font-bold text-lg text-gray-800 dark:text-white">0.00</span>
                    </div>
                    <div id="row-ss" class="hidden flex justify-between items-center p-3 bg-gradient-to-r from-orange-50 to-transparent dark:from-orange-900/10 rounded-xl">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Seguridad Social Empl. (14%):</span>
                        <span id="res-ss-empl" class="font-bold text-lg text-gray-800 dark:text-white">0.00</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-transparent dark:from-green-900/10 rounded-xl">
                        <span class="text-sm text-gray-600 dark:text-gray-400">ContribuciÃ³n CESS:</span>
                        <span id="res-cess" class="font-bold text-lg text-gray-800 dark:text-white">300.00</span>
                    </div>
                    <div class="pt-4 border-t-2 border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <span class="font-bold text-xl text-gray-800 dark:text-white">TOTAL A PAGAR:</span>
                        <span id="res-total" class="text-3xl font-black text-indigo-600 dark:text-indigo-400">300.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: CLIENTS -->
        <section id="section-records" class="hidden fade-in">
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-indigo-500"></i>
                        GestiÃ³n de Clientes
                    </h2>
                    <button onclick="promptNewClient()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold text-sm hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Nuevo Cliente
                    </button>
                </div>

                <div class="flex flex-wrap gap-2 mb-6" id="client-tags">
                    <!-- Clients will be rendered here -->
                </div>

                <div id="client-content" class="hidden">
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 p-6 rounded-2xl mb-6">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">Nuevo Movimiento</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <select id="move-type" class="input-field">
                                <option value="income">Ingreso (+)</option>
                                <option value="expense">Gasto (-)</option>
                            </select>
                            <input type="text" id="move-concept" class="input-field" placeholder="Concepto">
                            <input type="number" id="move-amount" class="input-field" placeholder="Monto $" min="0" step="100">
                            <input type="date" id="move-date" class="input-field">
                            <button onclick="addMovement()" class="px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold hover:shadow-lg hover:scale-105 transition-all">
                                Registrar
                            </button>
                        </div>
                    </div>

                    <!-- Client Summary -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-4 rounded-2xl text-white shadow-lg">
                            <p class="text-xs opacity-90 uppercase">Ingresos</p>
                            <p id="client-income-total" class="text-xl font-bold">0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-4 rounded-2xl text-white shadow-lg">
                            <p class="text-xs opacity-90 uppercase">Gastos</p>
                            <p id="client-expense-total" class="text-xl font-bold">0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-4 rounded-2xl text-white shadow-lg">
                            <p class="text-xs opacity-90 uppercase">Balance</p>
                            <p id="client-balance" class="text-xl font-bold">0.00</p>
                        </div>
                    </div>

                    <!-- Movements Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Tipo</th>
                                    <th class="text-right">Monto</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="no-client-hint" class="text-center py-12">
                    <i data-lucide="users" class="w-16 h-16 mx-auto mb-3 text-gray-400"></i>
                    <p class="text-gray-500 text-sm">Selecciona o crea un cliente para ver sus registros</p>
                </div>
            </div>
        </section>

        <!-- SECTION 3: TAXES -->
        <section id="section-taxes" class="hidden fade-in">
            <div class="glass-card p-6">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
                    <i data-lucide="receipt" class="w-5 h-5 text-indigo-500"></i>
                    Historial de Impuestos Pagados
                </h2>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Cliente</label>
                        <select id="tax-filter-client" class="input-field" onchange="filterTaxes()">
                            <option value="all">Todos los clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mes</label>
                        <select id="tax-filter-month" class="input-field" onchange="filterTaxes()">
                            <option value="all">Todos los meses</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">AÃ±o</label>
                        <select id="tax-filter-year" class="input-field" onchange="filterTaxes()">
                            <option value="all">Todos los aÃ±os</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="exportTaxesCSV()" class="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-2xl font-bold hover:shadow-lg hover:scale-105 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar CSV
                        </button>
                    </div>
                </div>
                
                <!-- Tax Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-4 rounded-2xl text-white">
                        <p class="text-xs opacity-90 uppercase">Total Impuestos</p>
                        <p id="tax-total-amount" class="text-2xl font-bold">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-4 rounded-2xl text-white">
                        <p class="text-xs opacity-90 uppercase">Ventas (10%)</p>
                        <p id="tax-total-sales" class="text-xl font-bold">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 p-4 rounded-2xl text-white">
                        <p class="text-xs opacity-90 uppercase">Personal (5%)</p>
                        <p id="tax-total-personal" class="text-xl font-bold">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-4 rounded-2xl text-white">
                        <p class="text-xs opacity-90 uppercase">CESS</p>
                        <p id="tax-total-cess" class="text-xl font-bold">0.00</p>
                    </div>
                </div>
                
                <!-- Tax Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th class="text-right">Ventas</th>
                                <th class="text-right">Personal</th>
                                <th class="text-right">F. Trabajo</th>
                                <th class="text-right">SS Empl.</th>
                                <th class="text-right">CESS</th>
                                <th class="text-right">Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tax-table-body"></tbody>
                        <tfoot id="tax-table-footer" class="bg-gray-50 dark:bg-gray-800 font-bold"></tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION 4: DJ ANUAL -->
        <section id="section-dj" class="hidden fade-in">
            <div class="glass-card p-6">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i>
                    DeclaraciÃ³n Jurada Anual
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Cliente</label>
                        <select id="dj-client" class="input-field" onchange="calculateDJ()">
                            <option value="all">Todos los clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">AÃ±o</label>
                        <select id="dj-year" class="input-field" onchange="calculateDJ()">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="generatePDF()" class="w-full px-4 py-3 bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-2xl font-bold hover:shadow-lg hover:scale-105 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Generar PDF
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white">
                        <p class="text-sm opacity-90 mb-2">Ingresos Totales</p>
                        <p id="dj-incomes" class="text-3xl font-bold">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-2xl text-white">
                        <p class="text-sm opacity-90 mb-2">Gastos Totales</p>
                        <p id="dj-expenses" class="text-3xl font-bold">0.00</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 p-8 rounded-2xl mb-6 text-center">
                    <p class="text-sm text-gray-400 uppercase tracking-wider mb-2">Rendimiento Neto</p>
                    <p id="dj-net" class="text-4xl font-black text-white">0.00</p>
                </div>
                
                <div class="space-y-3 text-gray-700 dark:text-gray-300">
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <span>MÃ­nimo Exento:</span>
                        <span class="font-bold">39,120.00</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <span>Base Imponible:</span>
                        <span id="dj-base" class="font-bold">0.00</span>
                    </div>
                    <div class="flex justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl font-bold text-lg">
                        <span>Impuesto DJ a Pagar:</span>
                        <span id="dj-tax" class="text-indigo-600 dark:text-indigo-400">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 5: REPORTS -->
        <section id="section-reports" class="hidden fade-in">
            <div class="glass-card p-6">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-indigo-500"></i>
                    Reportes y EstadÃ­sticas
                </h2>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl text-white">
                        <p class="text-sm opacity-90 mb-2">Total Clientes</p>
                        <p id="report-total-clients" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl text-white">
                        <p class="text-sm opacity-90 mb-2">Total Movimientos</p>
                        <p id="report-total-movements" class="text-4xl font-bold">0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-4 rounded-xl text-white">
                        <p class="text-xs opacity-90">Ingresos Totales</p>
                        <p id="report-total-income" class="text-2xl font-bold">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 p-4 rounded-xl text-white">
                        <p class="text-xs opacity-90">Gastos Totales</p>
                        <p id="report-total-expense" class="text-2xl font-bold">0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-500 to-cyan-600 p-4 rounded-xl text-white">
                        <p class="text-xs opacity-90">Balance Neto</p>
                        <p id="report-net" class="text-2xl font-bold">0.00</p>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="glass-card p-4">
                        <canvas id="incomeExpenseChart" style="height: 250px;"></canvas>
                    </div>
                    <div class="glass-card p-4">
                        <canvas id="taxBreakdownChart" style="height: 250px;"></canvas>
                    </div>
                </div>
                
                <!-- Client Breakdown -->
                <h3 class="text-md font-bold mb-4 text-gray-800 dark:text-white">Resumen por Cliente</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th class="text-right">Ingresos</th>
                                <th class="text-right">Gastos</th>
                                <th class="text-right">Balance</th>
                                <th class="text-right">Impuestos</th>
                            </tr>
                        </thead>
                        <tbody id="report-client-breakdown"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <footer class="text-center text-sm text-white/70 mt-10">
            Â© 2026 Gestor Fiscal TCP Pro Â· Onat Â· VersiÃ³n 3.0
        </footer>
    </div>

    <!-- Backup Buttons -->
    <div class="fixed bottom-6 right-6 flex gap-3">
        <button onclick="restoreFromBackup()" class="w-12 h-12 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl shadow-xl hover:shadow-2xl hover:scale-110 transition-all flex items-center justify-center">
            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
        </button>
        <button onclick="showBackupList()" class="w-12 h-12 bg-gradient-to-r from-indigo-600 to-cyan-600 text-white rounded-2xl shadow-xl hover:shadow-2xl hover:scale-110 transition-all flex items-center justify-center">
            <i data-lucide="archive" class="w-5 h-5"></i>
        </button>
    </div>

    <script>
        // ========== CONSTANTS ==========
        const TAX_RATES = {
            ventas: 0.10,
            ingresos_personales: 0.05,
            fuerza_trabajo: 0.05,
            seguridad_social_empleador: 0.14
        };
        
        const TAX_BRACKETS = [
            { min: 0, max: 39120, rate: 0, base: 0 },
            { min: 39120, max: 58680, rate: 0.15, base: 0 },
            { min: 58680, max: 90000, rate: 0.20, base: 2934 },
            { min: 90000, max: 120000, rate: 0.25, base: 9198 },
            { min: 120000, max: Infinity, rate: 0.30, base: 16698 }
        ];

        const DB_NAME = 'GestorOnatDB';
        const DB_VERSION = 1;
        const STORES = {
            CLIENTS: 'clientes',
            MOVEMENTS: 'movimientos',
            TAX_PAYMENTS: 'impuestos'
        };

        // ========== GOOGLE SHEETS SYNC ==========
        // âš ï¸ IMPORTANTE: Reemplaza con tu URL real de Google Apps Script
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwzUirSmEwxVYcmfxVptct8D86Cso_flWwEx_qR85bWkjLQoVTYuFhY7yC79zS_bhx_hw/exec';

        // ========== STATE ==========
        let state = {
            clients: [],
            taxPayments: [],
            selectedClientId: null,
            config: {
                hasEmployees: false,
                darkMode: false
            }
        };

        let dbInstance = null;
        let incomeExpenseChart = null;
        let taxBreakdownChart = null;

        // ========== INDEXEDDB FUNCTIONS ==========
        async function openDB() {
            return new Promise((resolve, reject) => {
                if (dbInstance) {
                    resolve(dbInstance);
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    dbInstance = request.result;
                    resolve(dbInstance);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORES.CLIENTS)) {
                        const clientStore = db.createObjectStore(STORES.CLIENTS, { keyPath: 'id' });
                        clientStore.createIndex('por_nombre', 'name', { unique: false });
                    }

                    if (!db.objectStoreNames.contains(STORES.MOVEMENTS)) {
                        const movementStore = db.createObjectStore(STORES.MOVEMENTS, { keyPath: 'id' });
                        movementStore.createIndex('por_cliente', 'clientId', { unique: false });
                        movementStore.createIndex('por_fecha', 'date', { unique: false });
                    }

                    if (!db.objectStoreNames.contains(STORES.TAX_PAYMENTS)) {
                        const taxStore = db.createObjectStore(STORES.TAX_PAYMENTS, { keyPath: 'id' });
                        taxStore.createIndex('por_cliente', 'clientId', { unique: false });
                        taxStore.createIndex('por_fecha', 'date', { unique: false });
                    }
                };
            });
        }

        async function dbGetAll(storeName) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbPut(storeName, data) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbDelete(storeName, id) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ========== SAVE FUNCTION ==========
        async function save(showNotification = false) {
            try {
                await openDB();

                // Save clients and their movements
                for (const client of state.clients) {
                    const { movements, ...clientData } = client;
                    await dbPut(STORES.CLIENTS, clientData);
                    
                    if (client.movements) {
                        for (const movement of client.movements) {
                            await dbPut(STORES.MOVEMENTS, { ...movement, clientId: client.id });
                        }
                    }
                }

                // Save tax payments
                for (const taxPayment of state.taxPayments) {
                    await dbPut(STORES.TAX_PAYMENTS, taxPayment);
                }

                localStorage.setItem('tcp_config', JSON.stringify(state.config));

                // Update indicator
                try {
                    const indicator = document.getElementById('save-indicator');
                    if (indicator) {
                        const icon = indicator.querySelector('i');
                        const text = indicator.querySelector('span');
                        
                        if (icon) icon.setAttribute('data-lucide', 'check-circle');
                        if (text) text.textContent = 'Guardado';
                        
                        if (typeof lucide !== 'undefined' && lucide.createIcons) {
                            lucide.createIcons();
                        }
                    }
                } catch (iconError) {
                    console.warn('Error updating icons:', iconError);
                }

                if (showNotification) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Â¡Ã‰xito!',
                        text: 'Datos guardados correctamente',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }

                // Try to sync if online
                if (navigator.onLine && GAS_URL && !GAS_URL.includes('TU_ID_AQUI')) {
                    syncWithGoogleSheets().catch(err => {
                        console.log('Sync in background:', err);
                    });
                }

                return true;
            } catch (error) {
                console.error('Error saving:', error);
                
                if (showNotification) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'AtenciÃ³n',
                        text: 'Datos guardados localmente',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                return false;
            }
        }

        // ========== LOAD FUNCTION ==========
        async function loadState() {
            try {
                await openDB();

                // Load clients
                const clients = await dbGetAll(STORES.CLIENTS);
                
                // Load all movements
                const allMovements = await dbGetAll(STORES.MOVEMENTS);
                
                // Group movements by client
                const movementsByClient = {};
                allMovements.forEach(m => {
                    if (!movementsByClient[m.clientId]) {
                        movementsByClient[m.clientId] = [];
                    }
                    movementsByClient[m.clientId].push(m);
                });

                // Attach movements to clients
                state.clients = clients.map(client => ({
                    ...client,
                    movements: movementsByClient[client.id] || []
                }));

                // Load tax payments
                state.taxPayments = await dbGetAll(STORES.TAX_PAYMENTS);

                // Load config
                const savedConfig = localStorage.getItem('tcp_config');
                if (savedConfig) {
                    state.config = JSON.parse(savedConfig);
                }

                // Set default client if needed
                if (state.clients.length > 0 && !state.selectedClientId) {
                    state.selectedClientId = state.clients[0].id;
                }

                console.log('âœ… State loaded from IndexedDB');
            } catch (error) {
                console.error('Error loading state:', error);
                // Fallback to example data
                if (state.clients.length === 0) {
                    state.clients = [{
                        id: 1,
                        name: "Cliente Ejemplo",
                        movements: []
                    }];
                    state.selectedClientId = 1;
                }
            }
            
            return state;
        }

        // ========== SYNC WITH GOOGLE SHEETS ==========
        async function syncWithGoogleSheets() {
            console.log('ðŸ”„ Iniciando sincronizaciÃ³n...');
            
            try {
                const clientsToSync = (state.clients || []).map(c => ({ 
                    id: c.id, 
                    name: c.name || 'Sin nombre' 
                }));
                
                const movementsToSync = [];
                (state.clients || []).forEach(c => {
                    if (c.movements && Array.isArray(c.movements)) {
                        c.movements.forEach(m => {
                            movementsToSync.push({ 
                                id: m.id, 
                                clientId: c.id, 
                                date: m.date || new Date().toISOString().split('T')[0],
                                type: m.type || 'income', 
                                concept: m.concept || 'Sin concepto', 
                                amount: m.amount || 0 
                            });
                        });
                    }
                });
                
                const payload = {
                    action: 'syncAll',
                    data: {
                        clients: clientsToSync,
                        movements: movementsToSync,
                        taxes: state.taxPayments || []
                    }
                };

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('âœ… Respuesta de Google Sheets:', result);

            } catch (error) {
                console.error('âš ï¸ Error de sincronizaciÃ³n:', error);
            }
        }

        // ========== INIT ==========
        window.onload = async () => {
            console.log('ðŸš€ Iniciando aplicaciÃ³n...');
            
            // Inicializar iconos
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (e) {
                console.warn('Error creando iconos:', e);
            }
            
            try {
                await loadState();
                renderClients();
                updateClientSelects();
                calculateTaxes();
                calculateReports();
                
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('move-date');
                if (dateInput) dateInput.value = today;
                
                // Apply dark mode
                if (state.config.darkMode) {
                    document.body.classList.add('dark');
                    updateDarkModeIcon();
                }
                
                // Connection status
                updateConnectionStatus();
                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);
                
                // Save before unload
                window.addEventListener('beforeunload', () => save());
                
                console.log('âœ… AplicaciÃ³n iniciada correctamente');
            } catch (error) {
                console.error('âŒ Error en inicio:', error);
            }
        };

        function updateConnectionStatus() {
            const status = document.getElementById('connection-status');
            if (navigator.onLine) {
                status.className = 'online';
                status.innerHTML = 'ðŸŸ¢ Conectado';
            } else {
                status.className = 'offline';
                status.innerHTML = 'ðŸ”´ Sin conexiÃ³n';
            }
        }

        // ========== DARK MODE ==========
        function toggleDarkMode() {
            state.config.darkMode = !state.config.darkMode;
            document.body.classList.toggle('dark', state.config.darkMode);
            updateDarkModeIcon();
            save();
        }

        function updateDarkModeIcon() {
            try {
                const icon = document.querySelector('button[onclick="toggleDarkMode()"] i');
                if (icon) {
                    icon.setAttribute('data-lucide', state.config.darkMode ? 'sun' : 'moon');
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons();
                    }
                }
            } catch (e) {
                console.warn('Error updating dark mode icon:', e);
            }
        }

        // ========== NAVIGATION ==========
        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(b => {
                b.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('section[id^="section-"]').forEach(s => {
                s.classList.add('hidden');
            });
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            
            if (tabId === 'dj') calculateDJ();
            if (tabId === 'taxes') renderTaxTable();
            if (tabId === 'reports') calculateReports();
        }

        // ========== CALCULATOR ==========
        function toggleEmployees() {
            state.config.hasEmployees = document.getElementById('has-employees').checked;
            document.getElementById('employee-inputs').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-work').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-ss').classList.toggle('hidden', !state.config.hasEmployees);
            calculateTaxes();
            save();
        }

        function calculateTaxes() {
            const income = parseFloat(document.getElementById('monthly-income')?.value) || 0;
            const empSalaries = parseFloat(document.getElementById('emp-salaries')?.value) || 0;
            const cess = parseFloat(document.getElementById('cess-scale')?.value) || 300;

            const vta = income * TAX_RATES.ventas;
            const personal = income * TAX_RATES.ingresos_personales;
            const work = state.config.hasEmployees ? (empSalaries * TAX_RATES.fuerza_trabajo) : 0;
            const ssEmpl = state.config.hasEmployees ? (empSalaries * TAX_RATES.seguridad_social_empleador) : 0;

            document.getElementById('res-sales').innerText = vta.toFixed(2);
            document.getElementById('res-personal').innerText = personal.toFixed(2);
            document.getElementById('res-work').innerText = work.toFixed(2);
            document.getElementById('res-ss-empl').innerText = ssEmpl.toFixed(2);
            document.getElementById('res-cess').innerText = cess.toFixed(2);

            const total = vta + personal + work + ssEmpl + cess;
            document.getElementById('res-total').innerText = total.toFixed(2);
            
            return { vta, personal, work, ssEmpl, cess, total };
        }

        // ========== REGISTER TAX PAYMENT ==========
        async function registerTaxPayment() {
            const clientId = document.getElementById('tax-client').value;
            if (!clientId) {
                Swal.fire('Error', 'Seleccione un cliente', 'error');
                return;
            }
            
            const client = state.clients.find(c => c.id == clientId);
            if (!client) {
                Swal.fire('Error', 'Cliente no encontrado', 'error');
                return;
            }
            
            const income = parseFloat(document.getElementById('monthly-income').value) || 0;
            
            if (income <= 0) {
                Swal.fire('Error', 'Ingrese ingresos vÃ¡lidos', 'error');
                return;
            }
            
            const taxes = calculateTaxes();
            
            const taxRecord = {
                id: Date.now(),
                clientId: client.id,
                clientName: client.name,
                date: new Date().toISOString().split('T')[0],
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                income: income,
                salesTax: taxes.vta,
                personalTax: taxes.personal,
                workTax: taxes.work,
                ssTax: taxes.ssEmpl,
                cess: taxes.cess,
                total: taxes.total,
                hasEmployees: state.config.hasEmployees
            };
            
            state.taxPayments.push(taxRecord);
            
            Swal.fire({
                icon: 'success',
                title: 'Â¡Registrado!',
                text: `Impuesto de ${taxes.total.toFixed(2)} CUP registrado`,
                timer: 1500,
                showConfirmButton: false
            });
            
            await save(true);
            
            document.getElementById('monthly-income').value = '';
            document.getElementById('emp-salaries').value = '';
            document.getElementById('tax-client').value = '';
            calculateTaxes();
        }

        // ========== CLIENTS ==========
        function updateClientSelects() {
            const selects = ['tax-client', 'dj-client', 'tax-filter-client'];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    
                    if (id === 'tax-filter-client' || id === 'dj-client') {
                        select.innerHTML = '<option value="all">Todos los clientes</option>';
                    } else {
                        select.innerHTML = '<option value="">Seleccionar cliente...</option>';
                    }
                    
                    state.clients.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });
                    
                    if (currentValue && Array.from(select.options).some(opt => opt.value == currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        async function promptNewClient() {
            const { value: name } = await Swal.fire({
                title: 'Nuevo Cliente',
                input: 'text',
                inputLabel: 'Nombre del cliente',
                inputPlaceholder: 'Ej: Juan PÃ©rez',
                showCancelButton: true,
                inputValidator: (value) => !value && 'Escribe un nombre'
            });
            
            if (name) {
                const newId = Date.now();
                state.clients.push({ 
                    id: newId, 
                    name, 
                    movements: [] 
                });
                renderClients();
                updateClientSelects();
                selectClient(newId);
                await save(true);
            }
        }

        function renderClients() {
            const container = document.getElementById('client-tags');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!state.clients || state.clients.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No hay clientes creados</p>';
                return;
            }
            
            state.clients.forEach(c => {
                const isActive = state.selectedClientId === c.id;
                const button = document.createElement('button');
                button.onclick = () => selectClient(c.id);
                button.className = `px-4 py-2 rounded-2xl text-xs font-bold whitespace-nowrap transition-all ${isActive ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-white/80 dark:bg-gray-800/80 text-gray-700 dark:text-gray-300 hover:scale-105'}`;
                button.textContent = c.name;
                container.appendChild(button);
            });
        }

        function selectClient(id) {
            state.selectedClientId = id;
            document.getElementById('no-client-hint').classList.add('hidden');
            document.getElementById('client-content').classList.remove('hidden');
            renderClients();
            renderMovements();
            updateClientSummary();
        }

        function renderMovements() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if (!client) return;
            
            const body = document.getElementById('movements-table-body');
            body.innerHTML = '';
            
            if (!client.movements || client.movements.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">No hay movimientos registrados</td></tr>';
                return;
            }
            
            client.movements.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            client.movements.forEach(m => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors';
                row.innerHTML = `
                    <td class="py-3">${m.date}</td>
                    <td class="py-3 font-medium">${m.concept}</td>
                    <td class="py-3">
                        <span class="badge ${m.type === 'income' ? 'badge-success' : 'badge-warning'}">
                            ${m.type === 'income' ? 'Ingreso' : 'Gasto'}
                        </span>
                    </td>
                    <td class="py-3 text-right font-bold ${m.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${m.type === 'income' ? '+' : '-'}${m.amount.toFixed(2)}
                    </td>
                    <td class="py-3 text-center">
                        <button onclick="deleteMovement(${client.id}, ${m.id})" class="text-red-400 hover:text-red-600 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });
            
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (e) {
                console.warn('Error creating icons:', e);
            }
        }

        function updateClientSummary() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if (!client) return;
            
            let income = 0, expense = 0;
            
            if (client.movements) {
                client.movements.forEach(m => {
                    if (m.type === 'income') income += m.amount;
                    else expense += m.amount;
                });
            }
            
            document.getElementById('client-income-total').innerText = income.toFixed(2);
            document.getElementById('client-expense-total').innerText = expense.toFixed(2);
            document.getElementById('client-balance').innerText = (income - expense).toFixed(2);
        }

        async function addMovement() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if (!client) return;
            
            const type = document.getElementById('move-type').value;
            const concept = document.getElementById('move-concept').value;
            const amount = parseFloat(document.getElementById('move-amount').value);
            const date = document.getElementById('move-date').value;

            if (!concept || isNaN(amount) || amount <= 0) {
                Swal.fire('Error', 'Completa todos los campos', 'error');
                return;
            }

            if (!client.movements) client.movements = [];
            
            client.movements.unshift({
                id: Date.now(),
                date: date,
                type, 
                concept, 
                amount
            });

            document.getElementById('move-concept').value = '';
            document.getElementById('move-amount').value = '';
            
            renderMovements();
            updateClientSummary();
            await save(true);
        }

        async function deleteMovement(clientId, movementId) {
            const result = await Swal.fire({
                title: 'Â¿Eliminar movimiento?',
                text: 'Esta acciÃ³n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'SÃ­, eliminar',
                cancelButtonText: 'Cancelar'
            });
            
            if (result.isConfirmed) {
                const client = state.clients.find(c => c.id === clientId);
                if (client && client.movements) {
                    client.movements = client.movements.filter(m => m.id !== movementId);
                    
                    await dbDelete(STORES.MOVEMENTS, movementId);
                    
                    renderMovements();
                    updateClientSummary();
                    await save(true);
                }
            }
        }

        // ========== TAXES ==========
        async function renderTaxTable() {
            const filterClient = document.getElementById('tax-filter-client').value;
            const filterMonth = document.getElementById('tax-filter-month').value;
            const filterYear = document.getElementById('tax-filter-year').value;
            
            let filtered = state.taxPayments ? [...state.taxPayments] : [];
            
            if (filterClient !== 'all') filtered = filtered.filter(t => t.clientId == filterClient);
            if (filterMonth !== 'all') filtered = filtered.filter(t => t.month == filterMonth);
            if (filterYear !== 'all') filtered = filtered.filter(t => t.year == filterYear);
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('tax-table-body');
            tbody.innerHTML = '';
            
            let totalSales = 0, totalPersonal = 0, totalWork = 0, totalSS = 0, totalCess = 0, totalAll = 0;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-400">No hay pagos registrados</td></tr>';
            } else {
                filtered.forEach(t => {
                    totalSales += t.salesTax || 0;
                    totalPersonal += t.personalTax || 0;
                    totalWork += t.workTax || 0;
                    totalSS += t.ssTax || 0;
                    totalCess += t.cess || 0;
                    totalAll += t.total || 0;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors';
                    row.innerHTML = `
                        <td class="py-3">${t.date}</td>
                        <td class="py-3 font-medium">${t.clientName}</td>
                        <td class="py-3 text-right">${(t.salesTax||0).toFixed(2)}</td>
                        <td class="py-3 text-right">${(t.personalTax||0).toFixed(2)}</td>
                        <td class="py-3 text-right">${(t.workTax||0).toFixed(2)}</td>
                        <td class="py-3 text-right">${(t.ssTax||0).toFixed(2)}</td>
                        <td class="py-3 text-right">${(t.cess||0).toFixed(2)}</td>
                        <td class="py-3 text-right font-bold text-indigo-600">${(t.total||0).toFixed(2)}</td>
                        <td class="py-3 text-center">
                            <button onclick="deleteTaxPayment(${t.id})" class="text-red-400 hover:text-red-600 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('tax-total-sales').innerText = totalSales.toFixed(2);
            document.getElementById('tax-total-personal').innerText = totalPersonal.toFixed(2);
            document.getElementById('tax-total-cess').innerText = totalCess.toFixed(2);
            document.getElementById('tax-total-amount').innerText = totalAll.toFixed(2);
            
            const footer = document.getElementById('tax-table-footer');
            if (footer) {
                footer.innerHTML = `
                    <tr>
                        <td colspan="2" class="py-3 text-right font-bold">TOTALES:</td>
                        <td class="py-3 text-right font-bold">${totalSales.toFixed(2)}</td>
                        <td class="py-3 text-right font-bold">${totalPersonal.toFixed(2)}</td>
                        <td class="py-3 text-right font-bold">${totalWork.toFixed(2)}</td>
                        <td class="py-3 text-right font-bold">${totalSS.toFixed(2)}</td>
                        <td class="py-3 text-right font-bold">${totalCess.toFixed(2)}</td>
                        <td class="py-3 text-right font-bold text-indigo-600">${totalAll.toFixed(2)}</td>
                        <td></td>
                    </tr>
                `;
            }
            
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
            } catch (e) {
                console.warn('Error creating icons:', e);
            }
        }

        function filterTaxes() {
            renderTaxTable();
        }

        async function deleteTaxPayment(id) {
            const result = await Swal.fire({
                title: 'Â¿Eliminar pago?',
                text: 'Esta acciÃ³n no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'SÃ­, eliminar',
                cancelButtonText: 'Cancelar'
            });
            
            if (result.isConfirmed) {
                state.taxPayments = state.taxPayments.filter(t => t.id !== id);
                await dbDelete(STORES.TAX_PAYMENTS, id);
                renderTaxTable();
                await save(true);
            }
        }

        function exportTaxesCSV() {
            if (!state.taxPayments || state.taxPayments.length === 0) {
                Swal.fire('Info', 'No hay datos para exportar', 'info');
                return;
            }
            
            let csv = 'Fecha,Cliente,Ingresos,Ventas,Personal,F.Trabajo,SS Empl,CESS,Total\n';
            state.taxPayments.forEach(t => {
                csv += `${t.date},${t.clientName},${t.income||0},${t.salesTax||0},${t.personalTax||0},${t.workTax||0},${t.ssTax||0},${t.cess||0},${t.total||0}\n`;
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `impuestos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ========== DJ ANUAL ==========
        function calculateDJ() {
            const clientId = document.getElementById('dj-client').value;
            const year = parseInt(document.getElementById('dj-year').value);
            
            let totalI = 0, totalE = 0;
            
            state.clients.forEach(c => {
                if (clientId !== 'all' && c.id != clientId) return;
                
                if (c.movements) {
                    c.movements.forEach(m => {
                        const mYear = new Date(m.date).getFullYear();
                        if (mYear === year) {
                            if (m.type === 'income') totalI += m.amount;
                            else totalE += m.amount;
                        }
                    });
                }
            });

            const net = totalI - totalE;
            const base = Math.max(0, net - 39120);
            
            let tax = 0;
            for (let bracket of TAX_BRACKETS) {
                if (net > bracket.min && net <= bracket.max) {
                    const taxable = net - bracket.min;
                    tax = bracket.base + (taxable * bracket.rate);
                    break;
                }
            }

            document.getElementById('dj-incomes').innerText = totalI.toFixed(2);
            document.getElementById('dj-expenses').innerText = totalE.toFixed(2);
            document.getElementById('dj-net').innerText = net.toFixed(2);
            document.getElementById('dj-base').innerText = base.toFixed(2);
            document.getElementById('dj-tax').innerText = tax.toFixed(2);
        }

        function generatePDF() {
            Swal.fire({
                icon: 'info',
                title: 'PrÃ³ximamente',
                text: 'La generaciÃ³n de PDF estarÃ¡ disponible en la prÃ³xima versiÃ³n'
            });
        }

        // ========== REPORTS ==========
        function calculateReports() {
            let totalClients = state.clients.length;
            let totalMovements = 0;
            let totalIncome = 0;
            let totalExpense = 0;
            
            state.clients.forEach(c => {
                if (c.movements) {
                    totalMovements += c.movements.length;
                    c.movements.forEach(m => {
                        if (m.type === 'income') totalIncome += m.amount;
                        else totalExpense += m.amount;
                    });
                }
            });
            
            document.getElementById('report-total-clients').innerText = totalClients;
            document.getElementById('report-total-movements').innerText = totalMovements;
            document.getElementById('report-total-income').innerText = totalIncome.toFixed(2);
            document.getElementById('report-total-expense').innerText = totalExpense.toFixed(2);
            document.getElementById('report-net').innerText = (totalIncome - totalExpense).toFixed(2);
            
            // Client breakdown
            const breakdown = document.getElementById('report-client-breakdown');
            breakdown.innerHTML = '';
            
            state.clients.forEach(c => {
                let clientIncome = 0, clientExpense = 0;
                if (c.movements) {
                    c.movements.forEach(m => {
                        if (m.type === 'income') clientIncome += m.amount;
                        else clientExpense += m.amount;
                    });
                }
                
                const clientTaxes = state.taxPayments?.filter(t => t.clientId === c.id).reduce((sum, t) => sum + t.total, 0) || 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors';
                row.innerHTML = `
                    <td class="py-3 font-medium">${c.name}</td>
                    <td class="py-3 text-right text-green-600">${clientIncome.toFixed(2)}</td>
                    <td class="py-3 text-right text-red-600">${clientExpense.toFixed(2)}</td>
                    <td class="py-3 text-right text-indigo-600">${(clientIncome - clientExpense).toFixed(2)}</td>
                    <td class="py-3 text-right text-purple-600">${clientTaxes.toFixed(2)}</td>
                `;
                breakdown.appendChild(row);
            });
            
            // Charts
            createCharts(totalIncome, totalExpense, state.taxPayments || []);
        }

        function createCharts(income, expense, taxPayments) {
            if (incomeExpenseChart) incomeExpenseChart.destroy();
            if (taxBreakdownChart) taxBreakdownChart.destroy();
            
            const ctx1 = document.getElementById('incomeExpenseChart')?.getContext('2d');
            if (ctx1) {
                incomeExpenseChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Ingresos', 'Gastos', 'Balance'],
                        datasets: [{
                            label: 'Monto (CUP)',
                            data: [income, expense, income - expense],
                            backgroundColor: ['#22c55e', '#ef4444', '#6366f1']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            const taxBreakdown = {
                sales: taxPayments.reduce((sum, t) => sum + (t.salesTax || 0), 0),
                personal: taxPayments.reduce((sum, t) => sum + (t.personalTax || 0), 0),
                work: taxPayments.reduce((sum, t) => sum + (t.workTax || 0), 0),
                ss: taxPayments.reduce((sum, t) => sum + (t.ssTax || 0), 0),
                cess: taxPayments.reduce((sum, t) => sum + (t.cess || 0), 0)
            };
            
            const ctx2 = document.getElementById('taxBreakdownChart')?.getContext('2d');
            if (ctx2) {
                taxBreakdownChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ventas', 'Personal', 'F. Trabajo', 'SS Empl', 'CESS'],
                        datasets: [{
                            data: [taxBreakdown.sales, taxBreakdown.personal, taxBreakdown.work, taxBreakdown.ss, taxBreakdown.cess],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        // ========== BACKUP & RESTORE ==========
        function createBackup() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_onat_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            Swal.fire({
                icon: 'success',
                title: 'Respaldo creado',
                text: 'Archivo descargado correctamente',
                timer: 1500,
                showConfirmButton: false
            });
        }

        async function restoreFromBackup() {
            const backups = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tcp_backup_')) {
                    backups.push(key);
                }
            }
            
            if (backups.length === 0) {
                Swal.fire('No hay respaldos', 'No se encontraron respaldos automÃ¡ticos', 'info');
                return;
            }
            
            let options = '<select id="backup-select" class="input-field w-full p-3 rounded-2xl">';
            backups.sort().reverse().forEach(key => {
                const date = key.replace('tcp_backup_', '');
                options += `<option value="${key}">ðŸ“… ${date}</option>`;
            });
            options += '</select>';
            
            Swal.fire({
                title: 'Restaurar respaldo',
                html: options,
                confirmButtonText: 'Restaurar',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                preConfirm: async () => {
                    const key = document.getElementById('backup-select').value;
                    const backupData = localStorage.getItem(key);
                    if (backupData) {
                        state = JSON.parse(backupData);
                        await save(true);
                        location.reload();
                    }
                }
            });
        }

        function showBackupList() {
            const backups = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tcp_backup_')) {
                    backups.push(key);
                }
            }
            
            if (backups.length === 0) {
                Swal.fire('No hay respaldos', 'No se encontraron respaldos automÃ¡ticos', 'info');
                return;
            }
            
            let html = '<div class="space-y-2 max-h-60 overflow-y-auto">';
            backups.sort().reverse().forEach(key => {
                const date = key.replace('tcp_backup_', '');
                html += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                    <span class="font-medium">ðŸ“… ${date}</span>
                    <button onclick="loadBackup('${key}')" class="px-4 py-1 bg-indigo-600 text-white rounded-xl text-xs font-bold hover:scale-105 transition-all">
                        Cargar
                    </button>
                </div>`;
            });
            html += '</div>';
            
            Swal.fire({
                title: 'Respaldos disponibles',
                html: html,
                confirmButtonText: 'Cerrar'
            });
        }

        window.loadBackup = async function(key) {
            const backupData = localStorage.getItem(key);
            if (backupData) {
                state = JSON.parse(backupData);
                await save(true);
                location.reload();
            }
        };

        // ========== IMPORT/EXPORT ==========
        function exportData() {
            createBackup();
        }

        async function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const imported = JSON.parse(text);
                
                const result = await Swal.fire({
                    title: 'Â¿Importar datos?',
                    text: 'Se reemplazarÃ¡n todos los datos actuales',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'SÃ­, importar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#ef4444'
                });
                
                if (result.isConfirmed) {
                    state = imported;
                    await save();
                    location.reload();
                }
            } catch (error) {
                Swal.fire('Error', 'Archivo invÃ¡lido', 'error');
            }
            e.target.value = '';
        }

        // Expose functions globally
        window.switchTab = switchTab;
        window.toggleDarkMode = toggleDarkMode;
        window.toggleEmployees = toggleEmployees;
        window.calculateTaxes = calculateTaxes;
        window.registerTaxPayment = registerTaxPayment;
        window.promptNewClient = promptNewClient;
        window.selectClient = selectClient;
        window.addMovement = addMovement;
        window.deleteMovement = deleteMovement;
        window.renderTaxTable = renderTaxTable;
        window.filterTaxes = filterTaxes;
        window.deleteTaxPayment = deleteTaxPayment;
        window.exportTaxesCSV = exportTaxesCSV;
        window.calculateDJ = calculateDJ;
        window.generatePDF = generatePDF;
        window.calculateReports = calculateReports;
        window.createBackup = createBackup;
        window.restoreFromBackup = restoreFromBackup;
        window.showBackupList = showBackupList;
        window.exportData = exportData;
        window.importData = importData;
    </script>
</body>
</html>
