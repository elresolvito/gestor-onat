<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Fiscal TCP - Cuba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .btn-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .btn-tab.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
            transform: scale(1.05);
        }

        .input-field {
            width: 100%;
            padding: 10px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            ring: 2px rgba(37, 99, 235, 0.1);
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            border-radius: 99px;
            position: relative;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .toggle-dot {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        input:checked + .toggle-switch {
            background-color: #22c55e;
        }

        input:checked + .toggle-switch .toggle-dot {
            transform: translateX(24px);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        
        <!-- Header Principal similar a la imagen -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-slate-800">Contabilidad TCP</h1>
            <div class="flex gap-2">
                <button onclick="exportData()" title="Guardar en Drive / Respaldo" class="p-2 bg-white border rounded-lg hover:bg-slate-50">
                    <i data-lucide="cloud-off" class="w-5 h-5 text-slate-400"></i>
                </button>
                <label class="p-2 bg-white border rounded-lg hover:bg-slate-50 cursor-pointer">
                    <i data-lucide="upload-cloud" class="w-5 h-5 text-slate-400"></i>
                    <input type="file" class="hidden" onchange="importData(event)">
                </label>
            </div>
        </header>

        <!-- Navegación por Iconos (Vistas) -->
        <nav class="grid grid-cols-3 gap-4 mb-8">
            <button onclick="switchTab('calc')" id="tab-calc" class="btn-tab active">
                <i data-lucide="calculator" class="mb-1"></i>
                <span class="text-xs font-bold">Calculadora</span>
            </button>
            <button onclick="switchTab('records')" id="tab-records" class="btn-tab bg-white">
                <i data-lucide="users" class="mb-1"></i>
                <span class="text-xs font-bold">Clientes</span>
            </button>
            <button onclick="switchTab('dj')" id="tab-dj" class="btn-tab bg-white">
                <i data-lucide="file-text" class="mb-1"></i>
                <span class="text-xs font-bold">DJ Anual</span>
            </button>
        </nav>

        <!-- SECCIÓN: CONFIGURACIÓN DE ACTIVIDAD -->
        <section id="section-calc">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 mb-4">Configuración de Actividad</h2>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl mb-4">
                    <span class="text-sm font-medium text-slate-600">¿Tiene empleados contratados?</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="has-employees" class="sr-only" onchange="toggleEmployees()">
                        <div class="toggle-switch bg-slate-300">
                            <div class="toggle-dot"></div>
                        </div>
                    </label>
                </div>

                <div id="employee-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 animate-in fade-in duration-300">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cant. Empleados</label>
                        <input type="number" id="emp-count" oninput="calculateTaxes()" class="input-field" value="1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Total Salarios (CUP)</label>
                        <input type="number" id="emp-salaries" oninput="calculateTaxes()" class="input-field" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Ingresos Brutos (Mes)</label>
                        <input type="number" id="monthly-income" oninput="calculateTaxes()" class="input-field" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Seguridad Social (CESS)</label>
                        <select id="cess-scale" onchange="calculateTaxes()" class="input-field">
                            <option value="300">Escala 2000 (Cuota 300)</option>
                            <option value="450">Escala 3000 (Cuota 450)</option>
                            <option value="750">Escala 5000 (Cuota 750)</option>
                            <option value="1500">Escala 10000 (Cuota 1500)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Resumen de Impuestos a Pagar -->
            <div class="section-card bg-white border-l-4 border-blue-600">
                <h2 class="text-lg font-bold text-slate-700 mb-4">Resumen de Impuestos a Pagar</h2>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Ventas/Servicios (10%):</span>
                        <span id="res-sales" class="font-bold">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Ingresos Personales (5%):</span>
                        <span id="res-personal" class="font-bold">0.00</span>
                    </div>
                    <div id="row-work" class="hidden flex justify-between text-sm">
                        <span class="text-slate-500">Util. Fuerza Trabajo (5%):</span>
                        <span id="res-work" class="font-bold">0.00</span>
                    </div>
                    <div id="row-ss" class="hidden flex justify-between text-sm">
                        <span class="text-slate-500">Seguridad Social Empl. (14%):</span>
                        <span id="res-ss-empl" class="font-bold">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Contribución CESS:</span>
                        <span id="res-cess" class="font-bold">0.00</span>
                    </div>
                    <div class="pt-3 border-t flex justify-between items-center">
                        <span class="font-bold text-slate-800">TOTAL A PAGAR:</span>
                        <span id="res-total" class="text-xl font-black text-blue-600">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN: REGISTROS POR CLIENTE -->
        <section id="section-records" class="hidden">
            <div class="section-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-slate-700">Historial por Cliente</h2>
                    <button onclick="promptNewClient()" class="text-blue-600 text-xs font-bold hover:underline">+ Nuevo Cliente</button>
                </div>

                <div class="flex gap-2 overflow-x-auto pb-4 mb-4" id="client-tags">
                    <!-- Clientes como etiquetas -->
                </div>

                <div id="client-content" class="hidden">
                    <div class="bg-slate-50 p-4 rounded-xl mb-6">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Nuevo Movimiento</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <select id="move-type" class="input-field text-xs">
                                <option value="income">Ingreso (+)</option>
                                <option value="expense">Gasto (-)</option>
                            </select>
                            <input type="text" id="move-concept" class="input-field text-xs" placeholder="Concepto">
                            <input type="number" id="move-amount" class="input-field text-xs" placeholder="Monto $">
                            <button onclick="addMovement()" class="bg-blue-600 text-white text-xs font-bold py-2 rounded-lg">Registrar</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="text-slate-400 border-b">
                                <tr>
                                    <th class="py-2">Fecha</th>
                                    <th class="py-2">Concepto</th>
                                    <th class="py-2 text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table-body">
                                <!-- Filas de movimientos -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="no-client-hint" class="text-center py-10 text-slate-400 text-sm">
                    Selecciona o crea un cliente para ver sus registros.
                </div>
            </div>
        </section>

        <!-- SECCIÓN: DJ ANUAL -->
        <section id="section-dj" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 mb-6">Declaración Jurada Anual</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-green-50 rounded-xl border border-green-100 text-center">
                        <p class="text-[10px] font-bold text-green-600 uppercase">Ingresos Totales</p>
                        <p id="dj-incomes" class="text-lg font-bold">0.00</p>
                    </div>
                    <div class="p-4 bg-red-50 rounded-xl border border-red-100 text-center">
                        <p class="text-[10px] font-bold text-red-600 uppercase">Gastos Totales</p>
                        <p id="dj-expenses" class="text-lg font-bold">0.00</p>
                    </div>
                </div>
                <div class="p-4 bg-slate-900 text-white rounded-xl mb-6 text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Rendimiento Neto</p>
                    <p id="dj-net" class="text-2xl font-black">0.00</p>
                </div>
                <div class="space-y-2 text-sm text-slate-600">
                    <div class="flex justify-between">
                        <span>Mínimo Exento:</span>
                        <span>39,120.00</span>
                    </div>
                    <div class="flex justify-between font-bold text-slate-800 pt-2 border-t">
                        <span>Impuesto DJ a Pagar:</span>
                        <span id="dj-tax">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center text-[10px] text-slate-400 mt-10">
            &copy; 2024 Gestor Fiscal TCP. Funciona sin conexión.
        </footer>
    </div>

    <script>
        // --- CONSTANTES ---
        const TAX_RATES = {
            ventas: 0.10,
            ingresos_personales: 0.05,
            fuerza_trabajo: 0.05,
            seguridad_social_empleador: 0.14
        };

        // --- ESTADO ---
        let state = {
            clients: [], // {id, name, movements: []}
            selectedClientId: null,
            config: {
                hasEmployees: false
            }
        };

        // --- INICIO ---
        window.onload = () => {
            lucide.createIcons();
            const saved = localStorage.getItem('tcp_data_v2');
            if(saved) state = JSON.parse(saved);
            renderClients();
            calculateTaxes();
        };

        function save() {
            localStorage.setItem('tcp_data_v2', JSON.stringify(state));
        }

        // --- NAVEGACIÓN ---
        function switchTab(tabId) {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active', 'bg-white'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            
            if(tabId === 'dj') calculateDJ();
        }

        // --- CALCULADORA ---
        function toggleEmployees() {
            state.config.hasEmployees = document.getElementById('has-employees').checked;
            document.getElementById('employee-inputs').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-work').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-ss').classList.toggle('hidden', !state.config.hasEmployees);
            calculateTaxes();
            save();
        }

        function calculateTaxes() {
            const income = parseFloat(document.getElementById('monthly-income').value) || 0;
            const empSalaries = parseFloat(document.getElementById('emp-salaries').value) || 0;
            const cess = parseFloat(document.getElementById('cess-scale').value);

            const vta = income * TAX_RATES.ventas;
            const personal = income * TAX_RATES.ingresos_personales;
            const work = state.config.hasEmployees ? (empSalaries * TAX_RATES.fuerza_trabajo) : 0;
            const ssEmpl = state.config.hasEmployees ? (empSalaries * TAX_RATES.seguridad_social_empleador) : 0;

            document.getElementById('res-sales').innerText = vta.toFixed(2);
            document.getElementById('res-personal').innerText = personal.toFixed(2);
            document.getElementById('res-work').innerText = work.toFixed(2);
            document.getElementById('res-ss-empl').innerText = ssEmpl.toFixed(2);
            document.getElementById('res-cess').innerText = cess.toFixed(2);

            const total = vta + personal + work + ssEmpl + cess;
            document.getElementById('res-total').innerText = total.toFixed(2);
        }

        // --- CLIENTES ---
        function promptNewClient() {
            const name = prompt("Nombre del nuevo cliente:");
            if(name) {
                state.clients.push({ id: Date.now(), name, movements: [] });
                renderClients();
                save();
            }
        }

        function renderClients() {
            const container = document.getElementById('client-tags');
            container.innerHTML = '';
            state.clients.forEach(c => {
                const isActive = state.selectedClientId === c.id;
                container.innerHTML += `
                    <button onclick="selectClient(${c.id})" class="px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-all ${isActive ? 'bg-blue-600 text-white' : 'bg-white text-slate-500 border'}">
                        ${c.name}
                    </button>
                `;
            });
        }

        function selectClient(id) {
            state.selectedClientId = id;
            document.getElementById('no-client-hint').classList.add('hidden');
            document.getElementById('client-content').classList.remove('hidden');
            renderClients();
            renderMovements();
        }

        function addMovement() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            const type = document.getElementById('move-type').value;
            const concept = document.getElementById('move-concept').value;
            const amount = parseFloat(document.getElementById('move-amount').value);

            if(!concept || isNaN(amount)) return;

            client.movements.unshift({
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                type, concept, amount
            });

            document.getElementById('move-concept').value = '';
            document.getElementById('move-amount').value = '';
            renderMovements();
            save();
        }

        function renderMovements() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            const body = document.getElementById('movements-table-body');
            body.innerHTML = '';
            client.movements.forEach(m => {
                body.innerHTML += `
                    <tr class="border-b border-slate-50">
                        <td class="py-3 text-slate-400">${m.date}</td>
                        <td class="py-3 font-medium">${m.concept}</td>
                        <td class="py-3 text-right font-bold ${m.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${m.type === 'income' ? '' : '-'}${m.amount.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
        }

        // --- DJ ---
        function calculateDJ() {
            let totalI = 0;
            let totalE = 0;
            state.clients.forEach(c => {
                c.movements.forEach(m => {
                    if(m.type === 'income') totalI += m.amount;
                    else totalE += m.amount;
                });
            });

            const net = totalI - totalE;
            const tax = Math.max(0, (net - 39120) * 0.15); // Cálculo simplificado 15% tras exento

            document.getElementById('dj-incomes').innerText = totalI.toFixed(2);
            document.getElementById('dj-expenses').innerText = totalE.toFixed(2);
            document.getElementById('dj-net').innerText = net.toFixed(2);
            document.getElementById('dj-tax').innerText = tax.toFixed(2);
        }

        // --- IMPORT/EXPORT ---
        function exportData() {
            const data = JSON.stringify(state);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contabilidad_tcp_backup.json';
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                state = JSON.parse(event.target.result);
                save();
                location.reload();
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
