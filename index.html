<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Fiscal TCP Pro - Cuba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <!-- SweetAlert2 para diálogos modernos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LZ-String para compresión -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            transition: background-color 0.3s;
        }
        
        body.dark {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .dark .section-card {
            background: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .btn-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #64748b;
            background: white;
        }
        
        .dark .btn-tab {
            background: #1e293b;
            color: #94a3b8;
        }

        .btn-tab.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
            transform: scale(1.05);
        }

        .input-field {
            width: 100%;
            padding: 10px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .dark .input-field {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            ring: 2px rgba(37, 99, 235, 0.1);
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            border-radius: 99px;
            position: relative;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .toggle-dot {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        input:checked + .toggle-switch {
            background-color: #22c55e;
        }

        input:checked + .toggle-switch .toggle-dot {
            transform: translateX(24px);
        }
        
        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        
        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: #1e293b;
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        [data-tooltip]:hover:before {
            opacity: 1;
        }
        
        .dark [data-tooltip]:before {
            background: #f1f5f9;
            color: #0f172a;
        }
        
        /* Estilos para tablas */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .dark .table-container {
            border-color: #334155;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f8fafc;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .dark th {
            background-color: #0f172a;
            color: #94a3b8;
            border-bottom-color: #334155;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }
        
        .dark td {
            border-bottom-color: #334155;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #22c55e20;
            color: #22c55e;
            border: 1px solid #22c55e40;
        }
        
        .badge-warning {
            background-color: #f59e0b20;
            color: #f59e0b;
            border: 1px solid #f59e0b40;
        }
        
        .badge-info {
            background-color: #3b82f620;
            color: #3b82f6;
            border: 1px solid #3b82f640;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Header con más opciones -->
        <header class="flex flex-wrap justify-between items-center mb-8 gap-2">
            <h1 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                <i data-lucide="calculator" class="w-6 h-6 text-blue-600"></i>
                Gestor Fiscal TCP Pro
            </h1>
            <div class="flex gap-2">
                <!-- Indicador de estado -->
                <div id="save-indicator" class="flex items-center gap-1 px-3 py-1 bg-white dark:bg-slate-800 rounded-full border text-xs" title="Estado de guardado">
                    <i data-lucide="cloud-off" class="w-3 h-3 text-slate-400"></i>
                    <span>Sin guardar</span>
                </div>
                
                <!-- Toggle tema oscuro -->
                <button onclick="toggleDarkMode()" class="p-2 bg-white dark:bg-slate-800 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700" title="Cambiar tema">
                    <i data-lucide="moon" class="w-5 h-5 text-slate-400"></i>
                </button>
                
                <button onclick="exportData()" title="Guardar en Drive / Respaldo" class="p-2 bg-white dark:bg-slate-800 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700">
                    <i data-lucide="cloud" class="w-5 h-5 text-slate-400"></i>
                </button>
                
                <label class="p-2 bg-white dark:bg-slate-800 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
                    <i data-lucide="upload-cloud" class="w-5 h-5 text-slate-400"></i>
                    <input type="file" class="hidden" onchange="importData(event)" accept=".json">
                </label>
            </div>
        </header>

        <!-- Navegación por Iconos (Vistas) -->
        <nav class="grid grid-cols-5 gap-4 mb-8">
            <button onclick="switchTab('calc')" id="tab-calc" class="btn-tab active">
                <i data-lucide="calculator" class="mb-1"></i>
                <span class="text-xs font-bold">Calculadora</span>
            </button>
            <button onclick="switchTab('records')" id="tab-records" class="btn-tab">
                <i data-lucide="users" class="mb-1"></i>
                <span class="text-xs font-bold">Clientes</span>
            </button>
            <button onclick="switchTab('taxes')" id="tab-taxes" class="btn-tab">
                <i data-lucide="receipt" class="mb-1"></i>
                <span class="text-xs font-bold">Impuestos</span>
            </button>
            <button onclick="switchTab('dj')" id="tab-dj" class="btn-tab">
                <i data-lucide="file-text" class="mb-1"></i>
                <span class="text-xs font-bold">DJ Anual</span>
            </button>
            <button onclick="switchTab('reports')" id="tab-reports" class="btn-tab">
                <i data-lucide="bar-chart-2" class="mb-1"></i>
                <span class="text-xs font-bold">Reportes</span>
            </button>
        </nav>

        <!-- SECCIÓN: CONFIGURACIÓN DE ACTIVIDAD -->
        <section id="section-calc">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Configuración de Actividad
                </h2>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl mb-4">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300">¿Tiene empleados contratados?</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="has-employees" class="sr-only" onchange="toggleEmployees()">
                        <div class="toggle-switch bg-slate-300 dark:bg-slate-600">
                            <div class="toggle-dot"></div>
                        </div>
                    </label>
                </div>

                <div id="employee-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 animate-in fade-in duration-300">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Número total de empleados">Cant. Empleados</label>
                        <input type="number" id="emp-count" oninput="calculateTaxes()" class="input-field" value="1" min="1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Total de salarios pagados en el mes">Total Salarios (CUP)</label>
                        <input type="number" id="emp-salaries" oninput="calculateTaxes()" class="input-field" placeholder="0.00" min="0" step="100">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Ingresos brutos del mes">Ingresos Brutos (Mes)</label>
                        <input type="number" id="monthly-income" oninput="calculateTaxes()" class="input-field" placeholder="0.00" min="0" step="100">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Aportación a la Seguridad Social">Seguridad Social (CESS)</label>
                        <select id="cess-scale" onchange="calculateTaxes()" class="input-field">
                            <option value="300">Escala 2000 (Cuota 300)</option>
                            <option value="450">Escala 3000 (Cuota 450)</option>
                            <option value="750">Escala 5000 (Cuota 750)</option>
                            <option value="1500">Escala 10000 (Cuota 1500)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1" data-tooltip="Cliente al que facturamos">Cliente</label>
                        <select id="tax-client" class="input-field">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-end">
                    <button onclick="registerTaxPayment()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Registrar Pago de Impuestos
                    </button>
                </div>
            </div>

            <!-- Resumen de Impuestos a Pagar -->
            <div class="section-card border-l-4 border-blue-600">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    Resumen de Impuestos a Pagar
                </h2>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Ventas/Servicios (10%):</span>
                        <span id="res-sales" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Ingresos Personales (5%):</span>
                        <span id="res-personal" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div id="row-work" class="hidden flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Util. Fuerza Trabajo (5%):</span>
                        <span id="res-work" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div id="row-ss" class="hidden flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Seguridad Social Empl. (14%):</span>
                        <span id="res-ss-empl" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Contribución CESS:</span>
                        <span id="res-cess" class="font-bold text-slate-800 dark:text-white">0.00</span>
                    </div>
                    <div class="pt-3 border-t dark:border-slate-700 flex justify-between items-center">
                        <span class="font-bold text-slate-800 dark:text-white">TOTAL A PAGAR:</span>
                        <span id="res-total" class="text-xl font-black text-blue-600">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN: REGISTROS POR CLIENTE -->
        <section id="section-records" class="hidden">
            <div class="section-card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-slate-700 dark:text-white flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        Historial por Cliente
                    </h2>
                    <button onclick="promptNewClient()" class="text-blue-600 text-xs font-bold hover:underline flex items-center gap-1">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Nuevo Cliente
                    </button>
                </div>

                <div class="flex gap-2 overflow-x-auto pb-4 mb-4" id="client-tags">
                    <!-- Clientes como etiquetas -->
                </div>

                <div id="client-content" class="hidden">
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl mb-6">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Nuevo Movimiento</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            <select id="move-type" class="input-field text-xs">
                                <option value="income">Ingreso (+)</option>
                                <option value="expense">Gasto (-)</option>
                            </select>
                            <input type="text" id="move-concept" class="input-field text-xs" placeholder="Concepto">
                            <input type="number" id="move-amount" class="input-field text-xs" placeholder="Monto $" min="0" step="100">
                            <input type="date" id="move-date" class="input-field text-xs" value="">
                            <button onclick="addMovement()" class="bg-blue-600 text-white text-xs font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                                Registrar
                            </button>
                        </div>
                    </div>

                    <!-- Resumen del cliente seleccionado -->
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded text-center">
                            <span class="text-[10px] text-green-600 dark:text-green-400 uppercase">Ingresos</span>
                            <p id="client-income-total" class="text-sm font-bold text-green-600">0.00</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 p-2 rounded text-center">
                            <span class="text-[10px] text-red-600 dark:text-red-400 uppercase">Gastos</span>
                            <p id="client-expense-total" class="text-sm font-bold text-red-600">0.00</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-center">
                            <span class="text-[10px] text-blue-600 dark:text-blue-400 uppercase">Balance</span>
                            <p id="client-balance" class="text-sm font-bold text-blue-600">0.00</p>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Tipo</th>
                                    <th class="text-right">Monto</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table-body">
                                <!-- Filas de movimientos -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="no-client-hint" class="text-center py-10 text-slate-400 text-sm">
                    <i data-lucide="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                    Selecciona o crea un cliente para ver sus registros.
                </div>
            </div>
        </section>

        <!-- SECCIÓN: REGISTRO DE IMPUESTOS POR CLIENTE -->
        <section id="section-taxes" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    Historial de Impuestos Pagados por Cliente
                </h2>
                
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cliente</label>
                        <select id="tax-filter-client" class="input-field text-sm" onchange="filterTaxes()">
                            <option value="all">Todos los clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Mes</label>
                        <select id="tax-filter-month" class="input-field text-sm" onchange="filterTaxes()">
                            <option value="all">Todos los meses</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Año</label>
                        <select id="tax-filter-year" class="input-field text-sm" onchange="filterTaxes()">
                            <option value="all">Todos los años</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="exportTaxesCSV()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition-colors flex items-center gap-1">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar CSV
                        </button>
                    </div>
                </div>
                
                <!-- Resumen de impuestos -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Total Impuestos</span>
                        <p id="tax-total-amount" class="text-xl font-bold text-blue-600">0.00</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Ventas (10%)</span>
                        <p id="tax-total-sales" class="text-lg font-bold text-purple-600">0.00</p>
                    </div>
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Ingresos Personales (5%)</span>
                        <p id="tax-total-personal" class="text-lg font-bold text-indigo-600">0.00</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg">
                        <span class="text-xs text-slate-500 dark:text-slate-400">CESS</span>
                        <p id="tax-total-cess" class="text-lg font-bold text-orange-600">0.00</p>
                    </div>
                </div>
                
                <!-- Tabla de impuestos -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Concepto</th>
                                <th class="text-right">Ventas (10%)</th>
                                <th class="text-right">Personal (5%)</th>
                                <th class="text-right">F. Trabajo</th>
                                <th class="text-right">SS Empl.</th>
                                <th class="text-right">CESS</th>
                                <th class="text-right">Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tax-table-body">
                            <!-- Filas de impuestos -->
                        </tbody>
                        <tfoot id="tax-table-footer" class="bg-slate-50 dark:bg-slate-800 font-bold">
                            <!-- Totales -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECCIÓN: DJ ANUAL -->
        <section id="section-dj" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-6 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    Declaración Jurada Anual
                </h2>
                
                <!-- Selector de cliente y año -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cliente</label>
                        <select id="dj-client" class="input-field" onchange="calculateDJ()">
                            <option value="all">Todos los clientes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Año</label>
                        <select id="dj-year" class="input-field" onchange="calculateDJ()">
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="generatePDF()" class="bg-red-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-700 transition-colors flex items-center gap-1">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            Generar PDF
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-100 dark:border-green-800 text-center">
                        <p class="text-[10px] font-bold text-green-600 dark:text-green-400 uppercase">Ingresos Totales</p>
                        <p id="dj-incomes" class="text-lg font-bold text-green-600">0.00</p>
                    </div>
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-800 text-center">
                        <p class="text-[10px] font-bold text-red-600 dark:text-red-400 uppercase">Gastos Totales</p>
                        <p id="dj-expenses" class="text-lg font-bold text-red-600">0.00</p>
                    </div>
                </div>
                <div class="p-4 bg-slate-900 text-white rounded-xl mb-6 text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Rendimiento Neto</p>
                    <p id="dj-net" class="text-2xl font-black">0.00</p>
                </div>
                
                <!-- Tabla de cálculo progresivo -->
                <div class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <div class="flex justify-between">
                        <span>Mínimo Exento:</span>
                        <span>39,120.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Base Imponible:</span>
                        <span id="dj-base">0.00</span>
                    </div>
                    <div class="flex justify-between font-bold text-slate-800 dark:text-white pt-2 border-t dark:border-slate-700">
                        <span>Impuesto DJ a Pagar:</span>
                        <span id="dj-tax" class="text-blue-600">0.00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN: REPORTES INDIVIDUALES POR CLIENTE -->
        <section id="section-reports" class="hidden">
            <div class="section-card">
                <h2 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    Reportes por Cliente
                </h2>
                
                <!-- Selector de cliente -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Seleccionar Cliente</label>
                        <select id="report-client" class="input-field" onchange="loadClientReport()">
                            <option value="">-- Seleccione un cliente --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Período</label>
                        <select id="report-period" class="input-field" onchange="loadClientReport()">
                            <option value="all">Todo el historial</option>
                            <option value="2024">Año 2024</option>
                            <option value="2023">Año 2023</option>
                            <option value="month">Este mes</option>
                        </select>
                    </div>
                </div>
                
                <!-- Mensaje cuando no hay cliente seleccionado -->
                <div id="no-client-report" class="text-center py-10 text-slate-400">
                    <i data-lucide="user" class="w-16 h-16 mx-auto mb-2 opacity-30"></i>
                    <p>Seleccione un cliente para ver su reporte individual</p>
                </div>
                
                <!-- Contenido del reporte por cliente (inicialmente oculto) -->
                <div id="client-report-content" class="hidden">
                    <!-- Cabecera con nombre del cliente -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 rounded-xl mb-6">
                        <h3 id="report-client-name" class="text-xl font-bold">Cliente</h3>
                        <p id="report-client-period" class="text-sm opacity-90">Período seleccionado</p>
                    </div>
                    
                    <!-- Tarjetas de resumen -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Ingresos Totales</p>
                            <p id="report-income" class="text-2xl font-bold text-green-600">0.00</p>
                            <p class="text-xs text-slate-400" id="report-income-count">0 operaciones</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl border border-red-100">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Gastos Totales</p>
                            <p id="report-expense" class="text-2xl font-bold text-red-600">0.00</p>
                            <p class="text-xs text-slate-400" id="report-expense-count">0 operaciones</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Balance Neto</p>
                            <p id="report-balance" class="text-2xl font-bold text-blue-600">0.00</p>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-100">
                            <p class="text-xs text-slate-500 dark:text-slate-400">Impuestos Pagados</p>
                            <p id="report-taxes" class="text-2xl font-bold text-purple-600">0.00</p>
                            <p class="text-xs text-slate-400" id="report-taxes-count">0 pagos</p>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border">
                            <canvas id="incomeExpenseChart" style="height: 300px;"></canvas>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border">
                            <canvas id="taxBreakdownChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Tabla de movimientos del cliente -->
                    <h3 class="text-md font-bold mb-3">Movimientos del Cliente</h3>
                    <div class="table-container mb-6">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Tipo</th>
                                    <th class="text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody id="report-movements-body">
                                <!-- Movimientos del cliente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Tabla de impuestos pagados por este cliente -->
                    <h3 class="text-md font-bold mb-3">Impuestos Pagados</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th class="text-right">Ventas</th>
                                    <th class="text-right">Personal</th>
                                    <th class="text-right">CESS</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody id="report-taxes-body">
                                <!-- Impuestos del cliente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center text-[10px] text-slate-400 mt-10">
            &copy; 2024 Gestor Fiscal TCP Pro. Funciona sin conexión.
        </footer>
    </div>

    <script>
        // --- CONSTANTES ---
        const TAX_RATES = {
            ventas: 0.10,
            ingresos_personales: 0.05,
            fuerza_trabajo: 0.05,
            seguridad_social_empleador: 0.14
        };
        
        // Tabla de impuestos progresivos (Cuba)
        const TAX_BRACKETS = [
            { min: 0, max: 39120, rate: 0, base: 0 },
            { min: 39120, max: 58680, rate: 0.15, base: 0 },
            { min: 58680, max: 90000, rate: 0.20, base: 2934 },
            { min: 90000, max: 120000, rate: 0.25, base: 9198 },
            { min: 120000, max: Infinity, rate: 0.30, base: 16698 }
        ];

        // --- ESTADO ---
        let state = {
            clients: [], // {id, name, movements: []}
            taxPayments: [], // Nuevo: registro de impuestos pagados por cliente
            selectedClientId: null,
            config: {
                hasEmployees: false,
                darkMode: false
            }
        };
        
        let saveTimeout;
        let hasUnsavedChanges = false;
        
        // Variables para gráficos
        let incomeExpenseChart = null;
        let taxBreakdownChart = null;

        // --- INICIO ---
        window.onload = () => {
            lucide.createIcons();
            loadState();
            renderClients();
            updateClientSelects();
            calculateTaxes();
            updateSaveIndicator();
            
            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('move-date').value = today;
            
            // Restaurar tema oscuro
            if(state.config.darkMode) {
                document.body.classList.add('dark');
                updateDarkModeIcon();
            }
        };

        function loadState() {
            try {
                const saved = localStorage.getItem('tcp_data_v4');
                if(saved) {
                    // Descomprimir si está comprimido
                    if(saved.startsWith('COMPRESSED:')) {
                        const compressed = saved.substring(10);
                        const decompressed = LZString.decompress(compressed);
                        if(decompressed) {
                            state = JSON.parse(decompressed);
                        }
                    } else {
                        state = JSON.parse(saved);
                    }
                }
                
                // Inicializar taxPayments si no existe
                if(!state.taxPayments) {
                    state.taxPayments = [];
                }
            } catch(e) {
                console.error('Error loading state:', e);
                Swal.fire('Error', 'No se pudo cargar los datos guardados', 'error');
            }
        }

        function save(showNotification = false) {
            hasUnsavedChanges = true;
            clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(() => {
                try {
                    // Comprimir datos para ahorrar espacio
                    const jsonString = JSON.stringify(state);
                    const compressed = 'COMPRESSED:' + LZString.compress(jsonString);
                    localStorage.setItem('tcp_data_v4', compressed);
                    
                    hasUnsavedChanges = false;
                    updateSaveIndicator();
                    
                    if(showNotification) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Guardado',
                            text: 'Datos guardados correctamente',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                } catch(e) {
                    console.error('Error saving:', e);
                    Swal.fire('Error', 'No se pudo guardar los datos', 'error');
                }
            }, 500);
            
            updateSaveIndicator();
        }

        function updateSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            const icon = indicator.querySelector('i');
            const text = indicator.querySelector('span');
            
            if(hasUnsavedChanges) {
                icon.setAttribute('data-lucide', 'cloud');
                text.textContent = 'Guardando...';
            } else {
                icon.setAttribute('data-lucide', 'cloud-off');
                text.textContent = 'Guardado';
            }
            lucide.createIcons();
        }

        // --- TEMA OSCURO ---
        function toggleDarkMode() {
            state.config.darkMode = !state.config.darkMode;
            document.body.classList.toggle('dark', state.config.darkMode);
            updateDarkModeIcon();
            save();
        }
        
        function updateDarkModeIcon() {
            const icon = document.querySelector('button[onclick="toggleDarkMode()"] i');
            if(icon) {
                icon.setAttribute('data-lucide', state.config.darkMode ? 'sun' : 'moon');
                lucide.createIcons();
            }
        }

        // --- NAVEGACIÓN ---
        function switchTab(tabId) {
            // Remover active de todos
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('active', 'bg-white');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Ocultar todas las secciones
            document.querySelectorAll('section[id^="section-"]').forEach(s => {
                s.classList.add('hidden');
            });
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            
            // Actualizar según la pestaña
            if(tabId === 'dj') calculateDJ();
            if(tabId === 'taxes') renderTaxTable();
            if(tabId === 'reports') updateClientSelects();
            
            // Guardar pestaña activa
            localStorage.setItem('active_tab', tabId);
        }

        // --- CALCULADORA ---
        function toggleEmployees() {
            state.config.hasEmployees = document.getElementById('has-employees').checked;
            document.getElementById('employee-inputs').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-work').classList.toggle('hidden', !state.config.hasEmployees);
            document.getElementById('row-ss').classList.toggle('hidden', !state.config.hasEmployees);
            calculateTaxes();
            save();
        }

        function calculateTaxes() {
            const income = parseFloat(document.getElementById('monthly-income').value) || 0;
            const empSalaries = parseFloat(document.getElementById('emp-salaries').value) || 0;
            const cess = parseFloat(document.getElementById('cess-scale').value);

            const vta = income * TAX_RATES.ventas;
            const personal = income * TAX_RATES.ingresos_personales;
            const work = state.config.hasEmployees ? (empSalaries * TAX_RATES.fuerza_trabajo) : 0;
            const ssEmpl = state.config.hasEmployees ? (empSalaries * TAX_RATES.seguridad_social_empleador) : 0;

            document.getElementById('res-sales').innerText = vta.toFixed(2);
            document.getElementById('res-personal').innerText = personal.toFixed(2);
            document.getElementById('res-work').innerText = work.toFixed(2);
            document.getElementById('res-ss-empl').innerText = ssEmpl.toFixed(2);
            document.getElementById('res-cess').innerText = cess.toFixed(2);

            const total = vta + personal + work + ssEmpl + cess;
            document.getElementById('res-total').innerText = total.toFixed(2);
            
            return { vta, personal, work, ssEmpl, cess, total };
        }

        // --- NUEVA FUNCIÓN: Registrar pago de impuestos por cliente ---
        function registerTaxPayment() {
            const clientId = document.getElementById('tax-client').value;
            if(!clientId) {
                Swal.fire('Error', 'Debe seleccionar un cliente', 'error');
                return;
            }
            
            const client = state.clients.find(c => c.id == clientId);
            const income = parseFloat(document.getElementById('monthly-income').value) || 0;
            
            if(income <= 0) {
                Swal.fire('Error', 'Debe ingresar un monto de ingresos válido', 'error');
                return;
            }
            
            const taxes = calculateTaxes();
            
            // Crear registro de impuesto
            const taxRecord = {
                id: Date.now(),
                clientId: client.id,
                clientName: client.name,
                date: new Date().toISOString().split('T')[0],
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                income: income,
                salesTax: taxes.vta,
                personalTax: taxes.personal,
                workTax: taxes.work,
                ssTax: taxes.ssEmpl,
                cess: taxes.cess,
                total: taxes.total,
                hasEmployees: state.config.hasEmployees
            };
            
            state.taxPayments.push(taxRecord);
            
            Swal.fire({
                icon: 'success',
                title: 'Impuesto registrado',
                text: `Pago de ${taxes.total.toFixed(2)} CUP registrado para ${client.name}`,
                timer: 2000
            });
            
            save(true);
            
            // Limpiar campos
            document.getElementById('monthly-income').value = '';
            document.getElementById('emp-salaries').value = '';
            document.getElementById('tax-client').value = '';
            
            calculateTaxes();
        }

        // --- CLIENTES ---
        function updateClientSelects() {
            // Actualizar select de clientes en calculadora
            const taxSelect = document.getElementById('tax-client');
            const djSelect = document.getElementById('dj-client');
            const reportSelect = document.getElementById('report-client');
            const taxFilterSelect = document.getElementById('tax-filter-client');
            
            [taxSelect, djSelect, reportSelect, taxFilterSelect].forEach(select => {
                if(select) {
                    const currentValue = select.value;
                    select.innerHTML = select.id === 'tax-filter-client' ? '<option value="all">Todos los clientes</option>' : '';
                    
                    if(select.id === 'dj-client' || select.id === 'report-client') {
                        select.innerHTML = '<option value="all">Todos los clientes</option>';
                    }
                    
                    state.clients.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });
                    
                    if(currentValue && Array.from(select.options).some(opt => opt.value == currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        async function promptNewClient() {
            const { value: name } = await Swal.fire({
                title: 'Nuevo Cliente',
                input: 'text',
                inputLabel: 'Nombre del cliente',
                inputPlaceholder: 'Ej: Juan Pérez',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'Debes escribir un nombre';
                    }
                }
            });
            
            if(name) {
                state.clients.push({ 
                    id: Date.now(), 
                    name, 
                    movements: [] 
                });
                renderClients();
                updateClientSelects();
                selectClient(state.clients[state.clients.length - 1].id);
                save(true);
            }
        }
        
        async function editClient(id) {
            const client = state.clients.find(c => c.id === id);
            const { value: name } = await Swal.fire({
                title: 'Editar Cliente',
                input: 'text',
                inputLabel: 'Nombre del cliente',
                inputValue: client.name,
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'Debes escribir un nombre';
                    }
                }
            });
            
            if(name) {
                client.name = name;
                
                // Actualizar nombre en pagos de impuestos
                state.taxPayments.forEach(t => {
                    if(t.clientId === id) {
                        t.clientName = name;
                    }
                });
                
                renderClients();
                updateClientSelects();
                save(true);
            }
        }
        
        async function deleteClient(id) {
            const result = await Swal.fire({
                title: '¿Eliminar cliente?',
                text: 'Se eliminarán todos sus movimientos y pagos de impuestos. Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar'
            });
            
            if(result.isConfirmed) {
                state.clients = state.clients.filter(c => c.id !== id);
                state.taxPayments = state.taxPayments.filter(t => t.clientId !== id);
                
                if(state.selectedClientId === id) {
                    state.selectedClientId = null;
                    document.getElementById('client-content').classList.add('hidden');
                    document.getElementById('no-client-hint').classList.remove('hidden');
                }
                
                renderClients();
                updateClientSelects();
                save(true);
                Swal.fire('Eliminado', 'Cliente eliminado correctamente', 'success');
            }
        }

        function renderClients() {
            const container = document.getElementById('client-tags');
            container.innerHTML = '';
            
            state.clients.forEach(c => {
                const isActive = state.selectedClientId === c.id;
                const button = document.createElement('div');
                button.className = 'relative group inline-block mr-2 mb-2';
                
                button.innerHTML = `
                    <button onclick="selectClient(${c.id})" 
                            class="px-4 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-all ${isActive ? 'bg-blue-600 text-white' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-300 border dark:border-slate-700'}">
                        ${c.name}
                    </button>
                    <div class="absolute top-0 right-0 hidden group-hover:flex gap-1 -mt-1 -mr-2 z-10">
                        <button onclick="editClient(${c.id})" class="bg-blue-500 text-white rounded-full p-0.5 w-5 h-5 flex items-center justify-center text-[8px] hover:bg-blue-600">
                            <i data-lucide="pencil" class="w-3 h-3"></i>
                        </button>
                        <button onclick="deleteClient(${c.id})" class="bg-red-500 text-white rounded-full p-0.5 w-5 h-5 flex items-center justify-center text-[8px] hover:bg-red-600">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(button);
            });
            
            lucide.createIcons();
        }

        function selectClient(id) {
            state.selectedClientId = id;
            document.getElementById('no-client-hint').classList.add('hidden');
            document.getElementById('client-content').classList.remove('hidden');
            renderClients();
            renderMovements();
            updateClientSummary();
        }

        function addMovement() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            const type = document.getElementById('move-type').value;
            const concept = document.getElementById('move-concept').value;
            const amount = parseFloat(document.getElementById('move-amount').value);
            const date = document.getElementById('move-date').value || new Date().toISOString().split('T')[0];

            if(!concept || isNaN(amount) || amount <= 0) {
                Swal.fire('Error', 'Debes completar todos los campos correctamente', 'error');
                return;
            }

            client.movements.unshift({
                id: Date.now(),
                date: date,
                type, 
                concept, 
                amount
            });

            document.getElementById('move-concept').value = '';
            document.getElementById('move-amount').value = '';
            document.getElementById('move-date').value = new Date().toISOString().split('T')[0];
            
            renderMovements();
            updateClientSummary();
            save(true);
        }
        
        async function deleteMovement(clientId, movementId) {
            const result = await Swal.fire({
                title: '¿Eliminar movimiento?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar'
            });
            
            if(result.isConfirmed) {
                const client = state.clients.find(c => c.id === clientId);
                client.movements = client.movements.filter(m => m.id !== movementId);
                renderMovements();
                updateClientSummary();
                save(true);
            }
        }

        function renderMovements() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if(!client) return;
            
            const body = document.getElementById('movements-table-body');
            body.innerHTML = '';
            
            client.movements.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            client.movements.forEach(m => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="py-2">${m.date}</td>
                    <td class="py-2">${m.concept}</td>
                    <td class="py-2">
                        <span class="badge ${m.type === 'income' ? 'badge-success' : 'badge-warning'}">
                            ${m.type === 'income' ? 'Ingreso' : 'Gasto'}
                        </span>
                    </td>
                    <td class="py-2 text-right font-bold ${m.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${m.type === 'income' ? '+' : '-'}${m.amount.toFixed(2)}
                    </td>
                    <td class="py-2 text-center">
                        <button onclick="deleteMovement(${client.id}, ${m.id})" class="text-red-400 hover:text-red-600 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                
                body.appendChild(row);
            });
            
            lucide.createIcons();
        }
        
        function updateClientSummary() {
            const client = state.clients.find(c => c.id === state.selectedClientId);
            if(!client) return;
            
            let income = 0;
            let expense = 0;
            
            client.movements.forEach(m => {
                if(m.type === 'income') income += m.amount;
                else expense += m.amount;
            });
            
            document.getElementById('client-income-total').innerText = income.toFixed(2);
            document.getElementById('client-expense-total').innerText = expense.toFixed(2);
            document.getElementById('client-balance').innerText = (income - expense).toFixed(2);
        }

        // --- FUNCIONES PARA IMPUESTOS (NUEVA SECCIÓN) ---
        function renderTaxTable() {
            const filterClient = document.getElementById('tax-filter-client').value;
            const filterMonth = document.getElementById('tax-filter-month').value;
            const filterYear = document.getElementById('tax-filter-year').value;
            
            let filteredPayments = [...state.taxPayments];
            
            // Aplicar filtros
            if(filterClient !== 'all') {
                filteredPayments = filteredPayments.filter(t => t.clientId == filterClient);
            }
            if(filterMonth !== 'all') {
                filteredPayments = filteredPayments.filter(t => t.month == filterMonth);
            }
            if(filterYear !== 'all') {
                filteredPayments = filteredPayments.filter(t => t.year == filterYear);
            }
            
            // Ordenar por fecha (más reciente primero)
            filteredPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('tax-table-body');
            tbody.innerHTML = '';
            
            let totalSales = 0, totalPersonal = 0, totalWork = 0, totalSS = 0, totalCess = 0, totalAll = 0;
            
            filteredPayments.forEach(t => {
                totalSales += t.salesTax || 0;
                totalPersonal += t.personalTax || 0;
                totalWork += t.workTax || 0;
                totalSS += t.ssTax || 0;
                totalCess += t.cess || 0;
                totalAll += t.total || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${t.date}</td>
                    <td class="py-2 font-medium">${t.clientName}</td>
                    <td class="py-2">Impuesto mensual</td>
                    <td class="py-2 text-right">${(t.salesTax || 0).toFixed(2)}</td>
                    <td class="py-2 text-right">${(t.personalTax || 0).toFixed(2)}</td>
                    <td class="py-2 text-right">${(t.workTax || 0).toFixed(2)}</td>
                    <td class="py-2 text-right">${(t.ssTax || 0).toFixed(2)}</td>
                    <td class="py-2 text-right">${(t.cess || 0).toFixed(2)}</td>
                    <td class="py-2 text-right font-bold text-blue-600">${(t.total || 0).toFixed(2)}</td>
                    <td class="py-2 text-center">
                        <button onclick="deleteTaxPayment(${t.id})" class="text-red-400 hover:text-red-600">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Actualizar resumen
            document.getElementById('tax-total-sales').innerText = totalSales.toFixed(2);
            document.getElementById('tax-total-personal').innerText = totalPersonal.toFixed(2);
            document.getElementById('tax-total-cess').innerText = totalCess.toFixed(2);
            document.getElementById('tax-total-amount').innerText = totalAll.toFixed(2);
            
            // Agregar footer
            const tfoot = document.getElementById('tax-table-footer');
            if(tfoot) {
                tfoot.innerHTML = `
                    <tr>
                        <td colspan="3" class="py-2 text-right font-bold">TOTALES:</td>
                        <td class="py-2 text-right font-bold">${totalSales.toFixed(2)}</td>
                        <td class="py-2 text-right font-bold">${totalPersonal.toFixed(2)}</td>
                        <td class="py-2 text-right font-bold">${totalWork.toFixed(2)}</td>
                        <td class="py-2 text-right font-bold">${totalSS.toFixed(2)}</td>
                        <td class="py-2 text-right font-bold">${totalCess.toFixed(2)}</td>
                        <td class="py-2 text-right font-bold text-blue-600">${totalAll.toFixed(2)}</td>
                        <td></td>
                    </tr>
                `;
            }
            
            lucide.createIcons();
        }
        
        function filterTaxes() {
            renderTaxTable();
        }
        
        async function deleteTaxPayment(id) {
            const result = await Swal.fire({
                title: '¿Eliminar pago de impuesto?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar'
            });
            
            if(result.isConfirmed) {
                state.taxPayments = state.taxPayments.filter(t => t.id !== id);
                renderTaxTable();
                save(true);
            }
        }
        
        function exportTaxesCSV() {
            let csv = 'Fecha,Cliente,Ingresos,Ventas (10%),Personal (5%),F.Trabajo (5%),SS Empl (14%),CESS,Total\n';
            
            state.taxPayments.forEach(t => {
                csv += `${t.date},${t.clientName},${t.income || 0},${t.salesTax || 0},${t.personalTax || 0},${t.workTax || 0},${t.ssTax || 0},${t.cess || 0},${t.total || 0}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `impuestos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // --- DJ ---
        function calculateDJ() {
            const clientId = document.getElementById('dj-client').value;
            const year = parseInt(document.getElementById('dj-year').value);
            
            let totalI = 0;
            let totalE = 0;
            
            state.clients.forEach(c => {
                // Si hay un cliente específico seleccionado, solo procesar ese
                if(clientId !== 'all' && c.id != clientId) return;
                
                c.movements.forEach(m => {
                    const mYear = new Date(m.date).getFullYear();
                    if(mYear === year) {
                        if(m.type === 'income') totalI += m.amount;
                        else totalE += m.amount;
                    }
                });
            });

            const net = totalI - totalE;
            const base = Math.max(0, net - 39120);
            
            // Calcular impuesto progresivo
            let tax = 0;
            for(let i = TAX_BRACKETS.length - 1; i >= 0; i--) {
                const bracket = TAX_BRACKETS[i];
                if(net > bracket.min) {
                    const taxable = Math.min(net, bracket.max) - bracket.min;
                    tax = bracket.base + (taxable * bracket.rate);
                    break;
                }
            }

            document.getElementById('dj-incomes').innerText = totalI.toFixed(2);
            document.getElementById('dj-expenses').innerText = totalE.toFixed(2);
            document.getElementById('dj-net').innerText = net.toFixed(2);
            document.getElementById('dj-base').innerText = base.toFixed(2);
            document.getElementById('dj-tax').innerText = tax.toFixed(2);
        }
        
        function generatePDF() {
            Swal.fire({
                icon: 'info',
                title: 'Generar PDF',
                text: 'Esta función generará un PDF con la declaración jurada',
                timer: 2000
            });
            // Aquí se implementaría la generación de PDF con una librería como jspdf
        }

        // --- REPORTES INDIVIDUALES POR CLIENTE ---
        function loadClientReport() {
            const clientId = document.getElementById('report-client').value;
            
            if(!clientId) {
                document.getElementById('no-client-report').classList.remove('hidden');
                document.getElementById('client-report-content').classList.add('hidden');
                return;
            }
            
            document.getElementById('no-client-report').classList.add('hidden');
            document.getElementById('client-report-content').classList.remove('hidden');
            
            const period = document.getElementById('report-period').value;
            const client = state.clients.find(c => c.id == clientId);
            
            if(!client) return;
            
            // Actualizar nombre del cliente en el reporte
            document.getElementById('report-client-name').innerText = client.name;
            
            // Filtrar movimientos según período
            let movements = [...client.movements];
            let taxPayments = state.taxPayments.filter(t => t.clientId == clientId);
            
            if(period !== 'all') {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                movements = movements.filter(m => {
                    const mDate = new Date(m.date);
                    if(period === 'month') {
                        return mDate.getMonth() + 1 === currentMonth && mDate.getFullYear() === currentYear;
                    } else {
                        return mDate.getFullYear() === parseInt(period);
                    }
                });
                
                taxPayments = taxPayments.filter(t => {
                    if(period === 'month') {
                        return t.month === currentMonth && t.year === currentYear;
                    } else {
                        return t.year === parseInt(period);
                    }
                });
            }
            
            // Calcular totales
            let income = 0, expense = 0;
            movements.forEach(m => {
                if(m.type === 'income') income += m.amount;
                else expense += m.amount;
            });
            
            const balance = income - expense;
            const totalTaxes = taxPayments.reduce((sum, t) => sum + t.total, 0);
            
            // Actualizar tarjetas
            document.getElementById('report-income').innerText = income.toFixed(2);
            document.getElementById('report-expense').innerText = expense.toFixed(2);
            document.getElementById('report-balance').innerText = balance.toFixed(2);
            document.getElementById('report-taxes').innerText = totalTaxes.toFixed(2);
            
            document.getElementById('report-income-count').innerText = `${movements.filter(m => m.type === 'income').length} operaciones`;
            document.getElementById('report-expense-count').innerText = `${movements.filter(m => m.type === 'expense').length} operaciones`;
            document.getElementById('report-taxes-count').innerText = `${taxPayments.length} pagos`;
            
            // Actualizar período
            let periodText = 'Todo el historial';
            if(period === 'month') periodText = 'Este mes';
            else if(period !== 'all') periodText = `Año ${period}`;
            document.getElementById('report-client-period').innerText = periodText;
            
            // Renderizar tabla de movimientos
            const movementsBody = document.getElementById('report-movements-body');
            movementsBody.innerHTML = '';
            movements.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(m => {
                movementsBody.innerHTML += `
                    <tr>
                        <td class="py-2">${m.date}</td>
                        <td class="py-2">${m.concept}</td>
                        <td class="py-2">
                            <span class="badge ${m.type === 'income' ? 'badge-success' : 'badge-warning'}">
                                ${m.type === 'income' ? 'Ingreso' : 'Gasto'}
                            </span>
                        </td>
                        <td class="py-2 text-right font-bold ${m.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${m.type === 'income' ? '+' : '-'}${m.amount.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            
            // Renderizar tabla de impuestos
            const taxesBody = document.getElementById('report-taxes-body');
            taxesBody.innerHTML = '';
            taxPayments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                taxesBody.innerHTML += `
                    <tr>
                        <td class="py-2">${t.date}</td>
                        <td class="py-2">Impuesto mensual</td>
                        <td class="py-2 text-right">${(t.salesTax || 0).toFixed(2)}</td>
                        <td class="py-2 text-right">${(t.personalTax || 0).toFixed(2)}</td>
                        <td class="py-2 text-right">${(t.cess || 0).toFixed(2)}</td>
                        <td class="py-2 text-right font-bold text-blue-600">${(t.total || 0).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            // Crear gráficos
            createCharts(income, expense, taxPayments);
        }
        
        function createCharts(income, expense, taxPayments) {
            // Destruir gráficos anteriores si existen
            if(incomeExpenseChart) incomeExpenseChart.destroy();
            if(taxBreakdownChart) taxBreakdownChart.destroy();
            
            // Gráfico de ingresos vs gastos
            const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
            incomeExpenseChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos', 'Balance'],
                    datasets: [{
                        label: 'Monto (CUP)',
                        data: [income, expense, income - expense],
                        backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'],
                        borderColor: ['#16a34a', '#dc2626', '#2563eb'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Gráfico de desglose de impuestos
            const taxBreakdown = {
                sales: taxPayments.reduce((sum, t) => sum + (t.salesTax || 0), 0),
                personal: taxPayments.reduce((sum, t) => sum + (t.personalTax || 0), 0),
                work: taxPayments.reduce((sum, t) => sum + (t.workTax || 0), 0),
                ss: taxPayments.reduce((sum, t) => sum + (t.ssTax || 0), 0),
                cess: taxPayments.reduce((sum, t) => sum + (t.cess || 0), 0)
            };
            
            const ctx2 = document.getElementById('taxBreakdownChart').getContext('2d');
            taxBreakdownChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: ['Ventas (10%)', 'Personal (5%)', 'F. Trabajo (5%)', 'SS Empl (14%)', 'CESS'],
                    datasets: [{
                        data: [taxBreakdown.sales, taxBreakdown.personal, taxBreakdown.work, taxBreakdown.ss, taxBreakdown.cess],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // --- IMPORT/EXPORT ---
        function exportData() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contabilidad_tcp_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            Swal.fire('Exportado', 'Archivo descargado correctamente', 'success');
        }

        async function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            try {
                const text = await file.text();
                const importedState = JSON.parse(text);
                
                // Validación básica
                if(!importedState.clients || !Array.isArray(importedState.clients)) {
                    throw new Error('Formato de archivo inválido');
                }
                
                const result = await Swal.fire({
                    title: '¿Importar datos?',
                    text: 'Se reemplazarán todos los datos actuales. ¿Continuar?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, importar'
                });
                
                if(result.isConfirmed) {
                    state = importedState;
                    // Asegurar que exista taxPayments
                    if(!state.taxPayments) state.taxPayments = [];
                    save();
                    location.reload();
                }
            } catch(error) {
                Swal.fire('Error', 'El archivo no es válido', 'error');
            }
            
            // Limpiar input
            e.target.value = '';
        }
    </script>
</body>
</html>
